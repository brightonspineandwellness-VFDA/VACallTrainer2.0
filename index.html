<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Front Desk Academy - Outbound Call Trainer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #16a085 0%, #2c3e50 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #16a085 0%, #2c3e50 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 40px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #16a085;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .difficulty-btn {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .difficulty-btn:hover { border-color: #16a085; transform: translateY(-2px); }
        .difficulty-btn.selected { background: #16a085; color: white; border-color: #16a085; }
        .start-btn {
            width: 100%;
            background: linear-gradient(135deg, #16a085 0%, #2c3e50 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-container {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.staff { background: #16a085; color: white; margin-left: auto; }
        .message.patient { background: white; border: 1px solid #ddd; }
        .message.system { background: #ffc107; text-align: center; max-width: 100%; }
        .end-call-btn {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .score-card { background: #f9f9f9; border-radius: 15px; padding: 25px; }
        .overall-score {
            font-size: 64px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .score-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status-listening { background: #e8f5e9; color: #2e7d32; }
        .status-speaking { background: #e3f2fd; color: #1565c0; }
        .status-thinking { background: #fff3e0; color: #ef6c00; }
        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        .feedback-section h4 { margin-bottom: 10px; color: #333; }
        .feedback-section ul { margin-left: 20px; }
        .feedback-section li { margin-bottom: 5px; }
        .positive { color: #2e7d32; }
        .negative { color: #c62828; }
        .critical { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // INDIVIDUAL PASSWORD SYSTEM
        // Add new VA passwords here
        // Roles: admin (see all), doctor (see only their office), va (see only themselves)
        const AUTHORIZED_USERS = {
            // ADMIN ACCESS - Sees all VAs from all offices
            "VFDA-ADMIN-2025": { 
                name: "Admin", 
                role: "admin" 
            },
            
            // CAMERON FAMILY CHIROPRACTIC
            "VFDA-CAMERON-DOC-2025": { 
                name: "Dr. Cameron", 
                office: "Cameron Family Chiropractic",
                role: "doctor" 
            },
            "VFDA-CAMERON-VA1-2025": { 
                name: "Cameron VA 1", 
                office: "Cameron Family Chiropractic",
                role: "va" 
            },
            "VFDA-CAMERON-VA2-2025": { 
                name: "Cameron VA 2", 
                office: "Cameron Family Chiropractic",
                role: "va" 
            },
            
            // ADVANCED INTEGRATED HEALTH
            "VFDA-ADVANCED-DOC-2025": { 
                name: "Dr. Advanced", 
                office: "Advanced Integrated Health",
                role: "doctor" 
            },
            "VFDA-ADVANCED-VA1-2025": { 
                name: "Advanced VA 1", 
                office: "Advanced Integrated Health",
                role: "va" 
            },
            
            // NEW HOPE FAMILY WELLNESS
            "VFDA-NEWHOPE-DOC-2025": { 
                name: "Dr. New Hope", 
                office: "New Hope Family Wellness",
                role: "doctor" 
            },
            "VFDA-NEWHOPE-VA1-2025": { 
                name: "New Hope VA 1", 
                office: "New Hope Family Wellness",
                role: "va" 
            },
            
            // PEAK PERFORMANCE CHIROPRACTIC
            "VFDA-PEAK-DOC-2025": { 
                name: "Dr. Peak", 
                office: "Peak Performance Chiropractic",
                role: "doctor" 
            },
            "VFDA-PEAK-VA1-2025": { 
                name: "Peak VA 1", 
                office: "Peak Performance Chiropractic",
                role: "va" 
            },
            
            // Add more offices here as needed
        };

        // LOCALSTORAGE FUNCTIONS (No external database needed!)
        const saveCallLog = (callData) => {
            const password = localStorage.getItem('user_password');
            const vaName = localStorage.getItem('va_name');
            
            // Get office from AUTHORIZED_USERS
            const userInfo = AUTHORIZED_USERS[password];
            const office = userInfo ? userInfo.office : 'none';
            
            const callLog = {
                id: Date.now(),
                password: password,
                vaName: vaName,
                office: office,
                timestamp: new Date().toISOString(),
                ...callData
            };
            
            // Get existing logs
            const existingLogs = JSON.parse(localStorage.getItem('outbound_call_logs') || '[]');
            
            // Add new log
            existingLogs.push(callLog);
            
            // Save back to localStorage
            localStorage.setItem('outbound_call_logs', JSON.stringify(existingLogs));
            
            console.log('Outbound call log saved:', callLog);
        };
        
        const getCallLogs = () => {
            const allLogs = JSON.parse(localStorage.getItem('outbound_call_logs') || '[]');
            const password = localStorage.getItem('user_password');
            const role = sessionStorage.getItem('user_role');
            const userOffice = sessionStorage.getItem('user_office');
            
            // Admin sees all logs
            if (role === 'admin') {
                return allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            
            // Doctor sees only their office's logs
            if (role === 'doctor') {
                return allLogs
                    .filter(log => log.office === userOffice)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            
            // VAs only see their own logs
            return allLogs
                .filter(log => log.password === password)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        };
        
        const deleteCallLog = (logId) => {
            const allLogs = JSON.parse(localStorage.getItem('outbound_call_logs') || '[]');
            const filteredLogs = allLogs.filter(log => log.id !== logId);
            localStorage.setItem('outbound_call_logs', JSON.stringify(filteredLogs));
        };
        
        const exportCallLogs = () => {
            const logs = getCallLogs();
            
            if (logs.length === 0) {
                alert('No call logs to export');
                return;
            }
            
            // Create CSV content
            const headers = ['Date', 'VA Name', 'Office', 'Doctor', 'Difficulty', 'Score', 'Patient Booked', 'Duration'];
            const rows = logs.map(log => [
                new Date(log.timestamp).toLocaleString(),
                log.vaName || 'N/A',
                log.officeName || 'N/A',
                log.doctorName || 'N/A',
                log.difficulty || 'N/A',
                log.score || 0,
                log.patientBooked ? 'Yes' : 'No',
                log.callDuration || 'N/A'
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `outbound-call-logs-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        function ChiroVoiceTrainer() {
            const [gameState, setGameState] = useState('password');
            const [password, setPassword] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [officeName, setOfficeName] = useState('');
            const [doctorName, setDoctorName] = useState('');
            const [vaName, setVaName] = useState('');
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [scoreData, setScoreData] = useState(null);
            const [interimText, setInterimText] = useState('');
            const [callStartTime, setCallStartTime] = useState(null);
            const [callEndTime, setCallEndTime] = useState(null);
            
            // API Key state - check localStorage reactively
            const [apiKeyInput, setApiKeyInput] = useState(() => {
                return localStorage.getItem('openai_api_key') || '';
            });
            const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(() => {
                return !localStorage.getItem('openai_api_key');
            });
            
            const wsRef = useRef(null);
            const audioContextRef = useRef(null);
            const conversationHistoryRef = useRef([]);
            const chatContainerRef = useRef(null);

            // Auto-scroll chat to bottom when new messages arrive
            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            // PASSWORD CHECK
            const handlePasswordSubmit = (e) => {
                e.preventDefault();
                const user = AUTHORIZED_USERS[password.toUpperCase()];
                if (user) {
                    setCurrentUser(user);
                    setGameState('setup');
                } else {
                    alert('Invalid password. Please try again.');
                }
            };

            // DIFFICULTY CONFIGURATIONS - OUTBOUND FOCUS
            const difficulties = {
                easy: {
                    name: 'Easy',
                    icon: 'üòä',
                    description: 'Cooperative Patient',
                    // LEAD INFORMATION
                    leadName: 'Jennifer Rodriguez',
                    leadPhone: '(555) 234-8901',
                    leadEmail: 'jennifer.rodriguez@email.com',
                    healthConcern: 'Lower back pain from desk work (2 weeks)',
                    formSubmitted: 'Yesterday, 2:30 PM',
                    personality: `You are Jennifer Rodriguez, a 34-year-old marketing manager who recently submitted an online inquiry form for chiropractic care. You've been experiencing lower back pain from sitting at your desk all day.

PERSONALITY TRAITS:
- Friendly and cooperative
- Expecting this follow-up call (you filled out a form yesterday)
- Ready to book an appointment
- You have some basic questions but are motivated to get help
- You respond well to professional, helpful service

YOUR SITUATION:
- Lower back pain for about 2 weeks, getting worse
- Works from home, sits 8-10 hours daily
- Has health insurance but willing to pay out-of-pocket if needed
- Prefers morning appointments (9-11am)
- Lives 15 minutes from the office
- Has never been to a chiropractor before but heard good things

HOW YOU RESPOND:
- Answer questions openly and honestly
- Ask 1-2 clarifying questions (cost, insurance, appointment length)
- Don't create unnecessary objections
- If offered a specific time, accept it if it works with your schedule
- Willing to pay initial fee when explained professionally
- Book the appointment if the VA handles the call well

IMPORTANT: Be realistic but cooperative. Show appreciation for the prompt follow-up call.`,
                },
                challenging: {
                    name: 'Challenging',
                    icon: 'ü§î',
                    description: 'Confused/Hesitant Patient',
                    // LEAD INFORMATION
                    leadName: 'Michael Chen',
                    leadPhone: '(555) 789-4562',
                    leadEmail: 'mchen.construction@email.com',
                    healthConcern: 'Chronic neck/shoulder pain from heavy lifting (5+ years)',
                    formSubmitted: '3 days ago, 11:45 AM',
                    personality: `You are Michael Chen, a 45-year-old construction supervisor who filled out an online form 3 days ago but has mixed feelings about following through. You have chronic neck and shoulder pain.

PERSONALITY TRAITS:
- Slightly forgetful (don't immediately recall filling out the form)
- Busy and distracted - answering during a work break
- Skeptical about chiropractic care (had a bad experience years ago)
- Cost-conscious and wants to know exact prices upfront
- Needs reassurance and clarity
- Not rude, just cautious and somewhat disorganized

YOUR SITUATION:
- Chronic neck/shoulder pain from heavy lifting (5+ years)
- Works long hours, hard to take time off
- Tried physical therapy before with limited success
- Filled out form after seeing Facebook ad, but now second-guessing it
- No insurance coverage for chiropractic
- Worried about costs and time commitment
- Prefers afternoon appointments (after 3pm) or Saturdays

YOUR OBJECTIONS & CONCERNS (raise these naturally):
1. "Wait, what form? Oh yeah... I think I remember that. Been so busy, I forgot."
2. "How much does this actually cost? I need to know upfront."
3. "I went to a chiropractor like 10 years ago and they wanted me to come 3 times a week forever. Is this the same thing?"
4. "I work construction - it's hard to take time off. How long is the appointment?"
5. "Do you take insurance? I don't think mine covers chiropractic."

HOW YOU RESPOND:
- Initially unclear about the call's purpose until reminded about the form
- Ask multiple questions before committing
- Need specific answers about cost, time, and treatment approach
- Express skepticism that needs to be addressed
- If the VA handles objections well and provides clear info, you'll book
- If rushed or given vague answers, you'll say "Let me think about it and call you back"
- Willing to pay initial fee IF the value is clearly explained
- Need reassurance this isn't a high-pressure sales situation

IMPORTANT: Don't be rude, but don't make it easy. The VA must earn your trust and handle your concerns professionally. If they do well, you'll book. If they struggle or seem pushy, you'll decline politely.`,
                }
            };

            // SYSTEM PROMPT FOR AI ASSISTANT - OUTBOUND SCENARIO
            function getSystemPrompt(difficulty) {
                const persona = difficulties[difficulty];
                const isJennifer = persona.leadName === 'Jennifer Rodriguez';
                const patientFirstName = isJennifer ? 'Jennifer' : 'Michael';
                const patientFullName = isJennifer ? 'JENNIFER RODRIGUEZ' : 'MICHAEL CHEN';
                
                return `üö®üö®üö® CRITICAL - READ THIS FIRST üö®üö®üö®

YOU ARE ${patientFullName} - THE PATIENT.
YOU ARE NOT EMMA. YOU ARE NOT THE VA. YOU ARE NOT THE RECEPTIONIST.
YOU ARE THE PERSON RECEIVING THE PHONE CALL.

The person speaking to you is the VA calling FROM the chiropractic office.
YOU are at home/work and YOUR phone is ringing.

üö´ NEVER EVER SAY THESE THINGS:
‚ùå "Hi Jennifer, this is Emma calling from..."
‚ùå "Hi Michael, this is calling from..."
‚ùå "This is [name] calling from Dr. [name]'s office..."
‚ùå "We received your inquiry about..."
‚ùå "How can I help you today?"
‚ùå ANY introduction of a chiropractic office
‚ùå ANY greeting as if YOU are calling THEM

‚úÖ ONLY SAY THINGS LIKE THIS WHEN YOUR PHONE RINGS:
‚úÖ "Hello?" 
‚úÖ "Hi, this is ${patientFirstName}"
‚úÖ "Speaking"
‚úÖ "Yes?"

YOU ARE THE PATIENT. YOUR PHONE RANG. YOU PICKED IT UP. YOU SAY "HELLO?"

${persona.personality}

=== ABSOLUTE RULES ===
1. YOU ARE ${patientFullName}
2. YOU ARE RECEIVING A CALL - you did NOT make this call
3. SPEAK ONLY IN ENGLISH - no Spanish, Portuguese, or other languages
4. DO NOT offer appointment times - WAIT for VA to suggest times
5. When VA offers times, pick one: "Monday at 10am works" or "Wednesday is better"
6. DO NOT volunteer your schedule or suggest your own times
7. Keep responses SHORT - 1 to 2 sentences maximum
8. You are at home/work, NOT at the chiropractic office

=== YOUR FIRST RESPONSE MUST BE ===
When you hear the VA speak for the first time, you MUST say ONLY:

"Hello?"

OR

"Hi, this is ${patientFirstName}"

DO NOT SAY ANYTHING ELSE FIRST. You don't know who's calling yet!

=== IF YOU CATCH YOURSELF SAYING ===
"Hi Jennifer, this is..." ‚Üê STOP! You ARE Jennifer!
"Hi Michael, this is..." ‚Üê STOP! You ARE Michael!
"This is calling from..." ‚Üê STOP! YOU didn't call anyone!
"We received your inquiry..." ‚Üê STOP! You're not the office!

Remember: A VA named Emma/Sarah/whoever is calling YOU. You pick up YOUR phone and say "Hello?"`;
            }

            // PLAY PHONE RINGING SOUND
            const playPhoneRing = async () => {
                console.log('üîî Playing phone ring sound...');
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Helper function to play a single beep
                const playBeep = (startTime, duration, frequency = 480) => {
                    return new Promise((resolve) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = frequency; // Phone ring frequency
                        gainNode.gain.value = 0.5; // Louder volume (was 0.3)
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + duration);
                        
                        setTimeout(resolve, duration * 1000);
                    });
                };
                
                // Play 3 rings (each ring = 2 beeps with small gap)
                for (let ring = 0; ring < 3; ring++) {
                    console.log(`üîî Ring ${ring + 1} of 3...`);
                    
                    // First beep
                    await playBeep(0, 0.4, 480);
                    await new Promise(resolve => setTimeout(resolve, 200)); // 200ms gap
                    
                    // Second beep
                    await playBeep(0, 0.4, 480);
                    
                    // Pause between rings (except after last ring)
                    if (ring < 2) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second pause
                    }
                }
                
                console.log('‚úÖ Phone ringing complete');
                await audioContext.close();
            };

            // START CALL
            const startCall = async () => {
                if (!officeName || !doctorName || !difficulty) {
                    alert('Please fill in all fields');
                    return;
                }

                // Check for API key
                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    alert('Please set your API key first');
                    setShowApiKeyPrompt(true);
                    return;
                }

                setGameState('calling');
                setMessages([{ type: 'system', text: 'üìû Calling patient... (Listen for ringing)' }]);
                conversationHistoryRef.current = [];
                setCurrentStatus('idle');

                try {
                    // Play actual phone ringing sound
                    console.log('Starting phone ring...');
                    await playPhoneRing();
                    console.log('Phone ring completed, patient answered');
                    
                    setMessages(prev => [...prev, { type: 'system', text: '‚úÖ Patient picked up! Start speaking now...' }]);
                    setCallStartTime(new Date());
                    
                    // Initialize Audio Context
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();

                    // Connect to OpenAI Realtime API
                    const ws = new WebSocket(
                        'wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17',
                        ['realtime', `openai-insecure-api-key.${apiKey}`, 'openai-beta.realtime-v1']
                    );

                    wsRef.current = ws;

                    ws.onopen = () => {
                        console.log('Connected to OpenAI Realtime API');
                        
                        // Configure session with longer silence duration to prevent interruptions
                        ws.send(JSON.stringify({
                            type: 'session.update',
                            session: {
                                modalities: ['text', 'audio'],
                                instructions: getSystemPrompt(difficulty),
                                voice: 'alloy',  // Natural, friendly voice for patient
                                input_audio_format: 'pcm16',
                                output_audio_format: 'pcm16',
                                input_audio_transcription: {
                                    model: 'whisper-1'
                                    // NOTE: prompt, language, temperature not supported in Realtime API
                                },
                                turn_detection: {
                                    type: 'server_vad',
                                    threshold: 0.7,  // More sensitive to catch all speech
                                    prefix_padding_ms: 800,  // Increased buffer to catch start of speech
                                    silence_duration_ms: 5000  // 5 FULL SECONDS of silence before AI responds
                                },
                                temperature: 0.6,  // Lower temperature for more consistent instruction following
                                max_response_output_tokens: 4096
                            }
                        }));

                        // Start audio capture
                        startAudioCapture();
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            handleRealtimeEvent(data);
                        } catch (error) {
                            console.error('Error parsing message:', error);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        alert('Connection error. Please try again.');
                        setGameState('setup');
                    };

                    ws.onclose = () => {
                        console.log('WebSocket closed');
                    };

                } catch (error) {
                    console.error('Error starting call:', error);
                    alert('Failed to start call. Please try again.');
                    setGameState('setup');
                }
            };

            // HANDLE REALTIME EVENTS
            const handleRealtimeEvent = (event) => {
                switch (event.type) {
                    case 'session.updated':
                        console.log('Session configured');
                        break;

                    case 'input_audio_buffer.speech_started':
                        console.log('üé§ Speech detected - You started speaking');
                        setCurrentStatus('listening');
                        setInterimText('');
                        break;

                    case 'input_audio_buffer.speech_stopped':
                        console.log('‚è∏Ô∏è Speech ended - Processing what you said...');
                        setCurrentStatus('thinking');
                        break;

                    case 'conversation.item.input_audio_transcription.completed':
                        const userText = event.transcript;
                        console.log('üìù YOU (VA) SAID:', userText);
                        console.log('üìù Raw transcript:', event);
                        setMessages(prev => [...prev, { type: 'staff', text: userText }]);
                        conversationHistoryRef.current.push({ role: 'user', text: userText });
                        setInterimText('');
                        break;

                    case 'conversation.item.input_audio_transcription.failed':
                        console.error('‚ùå Transcription failed:', event);
                        console.error('This usually means audio quality issues or API problems');
                        break;

                    case 'response.audio_transcript.delta':
                        setInterimText(prev => prev + event.delta);
                        break;

                    case 'response.audio_transcript.done':
                        const assistantText = event.transcript;
                        console.log('ü§ñ PATIENT SAID:', assistantText);
                        setMessages(prev => [...prev, { type: 'patient', text: assistantText }]);
                        conversationHistoryRef.current.push({ role: 'assistant', text: assistantText });
                        setInterimText('');
                        break;

                    case 'response.audio.delta':
                        if (event.delta) {
                            setCurrentStatus('speaking');
                            playAudioChunk(event.delta);
                        }
                        break;

                    case 'response.audio.done':
                        setCurrentStatus('idle');
                        break;

                    case 'response.done':
                        setCurrentStatus('idle');
                        break;

                    case 'error':
                        console.error('API Error:', event);
                        break;
                }
            };

            // AUDIO CAPTURE
            const startAudioCapture = async () => {
                try {
                    // Simplified but enhanced audio constraints
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const mediaRecorder = new MediaRecorder(stream);
                    const audioContext = audioContextRef.current;
                    const source = audioContext.createMediaStreamSource(stream);
                    const processor = audioContext.createScriptProcessor(4096, 1, 1);

                    source.connect(processor);
                    processor.connect(audioContext.destination);

                    processor.onaudioprocess = (e) => {
                        if (wsRef.current?.readyState === WebSocket.OPEN) {
                            const inputData = e.inputBuffer.getChannelData(0);
                            const pcm16 = float32ToPCM16(inputData);
                            const base64Audio = btoa(String.fromCharCode.apply(null, pcm16));
                            
                            wsRef.current.send(JSON.stringify({
                                type: 'input_audio_buffer.append',
                                audio: base64Audio
                            }));
                        }
                    };
                    
                    console.log('‚úÖ Microphone started with audio enhancements');
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Microphone access denied. Please allow microphone access and ensure you have a working microphone.');
                }
            };

            // AUDIO PLAYBACK - Fixed to prevent garbled audio
            let audioQueue = [];
            let isPlayingAudio = false;

            const playAudioChunk = (base64Audio) => {
                // Add to queue
                audioQueue.push(base64Audio);
                
                // If not currently playing, start playing
                if (!isPlayingAudio) {
                    playNextAudioChunk();
                }
            };

            const playNextAudioChunk = () => {
                if (audioQueue.length === 0) {
                    isPlayingAudio = false;
                    return;
                }

                isPlayingAudio = true;
                const base64Audio = audioQueue.shift();

                try {
                    const binaryString = atob(base64Audio);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    const pcm16 = new Int16Array(bytes.buffer);
                    const float32 = new Float32Array(pcm16.length);
                    for (let i = 0; i < pcm16.length; i++) {
                        float32[i] = pcm16[i] / 32768.0;
                    }

                    const audioContext = audioContextRef.current;
                    const buffer = audioContext.createBuffer(1, float32.length, 24000);
                    buffer.getChannelData(0).set(float32);

                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    
                    // When this chunk finishes, play the next one
                    source.onended = () => {
                        playNextAudioChunk();
                    };
                    
                    source.start();
                } catch (error) {
                    console.error('Error playing audio:', error);
                    // Continue to next chunk even if this one failed
                    playNextAudioChunk();
                }
            };

            // CONVERT FLOAT32 TO PCM16
            const float32ToPCM16 = (float32Array) => {
                const pcm16 = new Int16Array(float32Array.length);
                for (let i = 0; i < float32Array.length; i++) {
                    const s = Math.max(-1, Math.min(1, float32Array[i]));
                    pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                return new Uint8Array(pcm16.buffer);
            };

            // END CALL AND SCORE
            const endCall = async () => {
                const endTime = new Date();
                setCallEndTime(endTime);
                
                // Close WebSocket
                if (wsRef.current) {
                    wsRef.current.close();
                }

                // Close audio context
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                }

                setCurrentStatus('idle');
                
                // Show scoring screen immediately with loading state
                setGameState('scoring');
                setScoreData(null); // Set to null initially

                console.log('üîÑ Starting evaluation...');
                console.log('Conversation history:', conversationHistoryRef.current);

                // Get AI scoring
                try {
                    // Get API key from localStorage
                    const apiKey = localStorage.getItem('openai_api_key');
                    console.log('API Key found:', apiKey ? 'Yes' : 'No');
                    
                    if (!apiKey) {
                        console.error('‚ùå No API key in localStorage');
                        throw new Error('API key not found in localStorage. Please refresh and enter your API key.');
                    }

                    const scoringPrompt = `Analyze this OUTBOUND follow-up call conversation and provide detailed scoring.

CONVERSATION TRANSCRIPT:
${conversationHistoryRef.current.map(msg => `${msg.role === 'user' ? 'VA' : 'Patient'}: ${msg.text}`).join('\n')}

CONTEXT:
- Office: ${officeName}
- Doctor: Dr. ${doctorName}
- Scenario: VA calling patient who submitted online inquiry form
- Difficulty: ${difficulty}

IMPORTANT: Evaluate based on what actually happened in the conversation above.

SCORE THE FOLLOWING 7 CHECKPOINTS (0-10 points each):

1. PROFESSIONAL INTRODUCTION (0-10):
   - Did VA clearly state their name and the office name?
   - Was the greeting professional and friendly?
   - Did they verify they were speaking with the right person?

2. HEALTH HISTORY INQUIRY (0-10):
   - Did VA ask about patient's health concerns or pain?
   - Did they show genuine interest in understanding the situation?

3. PURPOSE STATED (0-10):
   - Did VA clearly explain they were following up on the patient's inquiry form?
   - Was the purpose of the call immediately clear?

4. SPECIFIC APPOINTMENT OPTIONS (0-10):
   - Did VA propose specific dates and times (not just "what works for you")?
   - Did they offer multiple options?

5. OBJECTION HANDLING (0-10):
   - Did VA address patient questions confidently?
   - How well did they handle cost concerns or questions?

6. PAYMENT COLLECTION (0-10):
   - Did VA clearly explain the initial payment amount and what it includes?
   - Did they explain the value?

7. CLOSING & CONFIRMATION (0-10):
   - Did VA confirm the appointment details?
   - Did they explain next steps?

BONUS POINTS (up to 30 points total):
- Communication Excellence (0-10): Clarity, pace, tone
- Professionalism (0-10): Courtesy, confidence, empathy
- Problem Solving (0-10): Flexibility, handling objections

ALSO DETERMINE:
- Did the patient ultimately BOOK the appointment? (true/false)

Return ONLY a valid JSON object (no markdown, no backticks):
{
  "scores": {
    "introduction": {"score": 0, "note": ""},
    "healthHistory": {"score": 0, "note": ""},
    "purposeStated": {"score": 0, "note": ""},
    "appointmentOptions": {"score": 0, "note": ""},
    "objectionHandling": {"score": 0, "note": ""},
    "paymentCollection": {"score": 0, "note": ""},
    "closingConfirmation": {"score": 0, "note": ""}
  },
  "bonus": 0,
  "bonusBreakdown": {"communication": 0, "professionalism": 0, "problemSolving": 0},
  "totalScore": 0,
  "patientBooked": false,
  "summary": "",
  "positives": [],
  "improvements": [],
  "criticalMisses": []
}`;

                    console.log('üì° Calling OpenAI for scoring...');

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are an expert chiropractic office trainer. Return ONLY valid JSON, no markdown.'
                                },
                                {
                                    role: 'user',
                                    content: scoringPrompt
                                }
                            ],
                            response_format: { type: 'json_object' },
                            temperature: 0.3
                        })
                    });

                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        throw new Error(`OpenAI API returned ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ Received scoring data:', data);
                    
                    const scoring = JSON.parse(data.choices[0].message.content);
                    console.log('‚úÖ Parsed scoring:', scoring);
                    
                    // Set the score data
                    setScoreData(scoring);

                    // Save call log to localStorage
                    const callDuration = callStartTime && endTime ? 
                        Math.floor((endTime - callStartTime) / 1000) : 0;
                    
                    saveCallLog({
                        difficulty: difficulty,
                        score: scoring.totalScore,
                        patientBooked: scoring.patientBooked,
                        callDuration: `${Math.floor(callDuration / 60)}m ${callDuration % 60}s`,
                        officeName: officeName,
                        doctorName: doctorName,
                        checkpointScores: scoring.scores,
                        bonusPoints: scoring.bonus
                    });

                    console.log('‚úÖ Scoring complete and saved');

                } catch (error) {
                    console.error('‚ùå Error scoring call:', error);
                    console.error('Error details:', error.message);
                    
                    // Provide default scoring that's guaranteed to work
                    const fallbackScoring = {
                        scores: {
                            introduction: {score: 5, note: 'Could not evaluate - scoring error'},
                            healthHistory: {score: 5, note: 'Could not evaluate - scoring error'},
                            purposeStated: {score: 5, note: 'Could not evaluate - scoring error'},
                            appointmentOptions: {score: 5, note: 'Could not evaluate - scoring error'},
                            objectionHandling: {score: 5, note: 'Could not evaluate - scoring error'},
                            paymentCollection: {score: 5, note: 'Could not evaluate - scoring error'},
                            closingConfirmation: {score: 5, note: 'Could not evaluate - scoring error'}
                        },
                        bonus: 0,
                        bonusBreakdown: {communication: 0, professionalism: 0, problemSolving: 0},
                        totalScore: 35,
                        patientBooked: false,
                        summary: `Scoring failed: ${error.message}. Please check your API key and try again.`,
                        positives: ['Call completed'],
                        improvements: ['Fix API key issue and try again'],
                        criticalMisses: []
                    };
                    
                    setScoreData(fallbackScoring);
                    console.log('‚ö†Ô∏è Using fallback scoring');
                }
            };

            // RESET GAME
            const resetGame = () => {
                setGameState('setup');
                setMessages([]);
                setScoreData(null);
                setDifficulty('');
                conversationHistoryRef.current = [];
                setCurrentStatus('idle');
                setInterimText('');
                setCallStartTime(null);
                setCallEndTime(null);
            };

            // PASSWORD SCREEN
            if (gameState === 'password') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Outbound Call Trainer</h1>
                            <p>Virtual Front Desk Academy</p>
                        </div>
                        <div className="content">
                            <form onSubmit={handlePasswordSubmit}>
                                <div className="form-group">
                                    <label>Enter Your Training Password:</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="VFDA-OFFICE-VA#-2025"
                                        autoFocus
                                    />
                                </div>
                                <button type="submit" className="start-btn">
                                    üîì Access Training
                                </button>
                            </form>
                            <div style={{marginTop: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '10px', fontSize: '14px'}}>
                                <strong>Password Format:</strong> VFDA-OFFICENAME-VA#-2025
                                <br/><br/>
                                Don't have a password? Contact your office manager.
                            </div>
                        </div>
                    </div>
                );
            }

            // API KEY PROMPT SCREEN
            if (showApiKeyPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîë OpenAI API Key Required</h1>
                            <p>One-time setup</p>
                        </div>
                        <div className="content">
                            <div style={{padding: '15px', background: '#fff3cd', borderRadius: '10px', marginBottom: '20px', fontSize: '14px'}}>
                                <strong>‚ö†Ô∏è You only need to do this once!</strong>
                                <ul style={{marginTop: '10px', marginLeft: '20px', textAlign: 'left'}}>
                                    <li>Get your API key from: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></li>
                                    <li>API keys start with <strong>"sk-"</strong> or <strong>"sk-proj-"</strong></li>
                                    <li>Your key will be saved to this browser</li>
                                </ul>
                            </div>
                            <div className="form-group">
                                <label>OpenAI API Key:</label>
                                <input
                                    type="password"
                                    value={apiKeyInput}
                                    onChange={(e) => setApiKeyInput(e.target.value)}
                                    placeholder="sk-proj-..."
                                    autoFocus
                                />
                            </div>
                            <button 
                                className="start-btn" 
                                onClick={() => {
                                    if (apiKeyInput && apiKeyInput.startsWith('sk-')) {
                                        localStorage.setItem('openai_api_key', apiKeyInput);
                                        setShowApiKeyPrompt(false);
                                    } else {
                                        alert('Please enter a valid OpenAI API key (starts with sk-)');
                                    }
                                }}
                                disabled={!apiKeyInput}
                            >
                                üíæ Save & Continue
                            </button>
                            {localStorage.getItem('openai_api_key') && (
                                <button 
                                    className="start-btn" 
                                    onClick={() => setShowApiKeyPrompt(false)}
                                    style={{marginTop: '10px', background: '#757575'}}
                                >
                                    Skip (Use Existing Key)
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // SETUP SCREEN
            if (gameState === 'setup') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Outbound Call Trainer</h1>
                            <p>New Patient Follow-Up Scenario</p>
                        </div>
                        <div className="content">
                            <div style={{marginBottom: '25px', padding: '15px', background: '#e8f5e9', borderRadius: '10px'}}>
                                <strong>‚úì Logged in as:</strong> {currentUser.name}
                                {currentUser.office && <span> - {currentUser.office}</span>}
                                <button 
                                    onClick={() => setShowApiKeyPrompt(true)}
                                    style={{float: 'right', background: '#757575', color: 'white', border: 'none', padding: '5px 10px', borderRadius: '5px', cursor: 'pointer', fontSize: '12px'}}
                                >
                                    üîë Change API Key
                                </button>
                            </div>

                            <div className="form-group">
                                <label>Office Name:</label>
                                <input
                                    type="text"
                                    value={officeName}
                                    onChange={(e) => setOfficeName(e.target.value)}
                                    placeholder="e.g., Brighton Spine & Wellness"
                                />
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Doctor Name:</label>
                                    <input
                                        type="text"
                                        value={doctorName}
                                        onChange={(e) => setDoctorName(e.target.value)}
                                        placeholder="e.g., Johnson"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Your Name (Optional):</label>
                                    <input
                                        type="text"
                                        value={vaName}
                                        onChange={(e) => setVaName(e.target.value)}
                                        placeholder="Your name"
                                    />
                                </div>
                            </div>

                            <div style={{marginTop: '30px', marginBottom: '15px'}}>
                                <h3 style={{marginBottom: '10px'}}>Select Difficulty:</h3>
                            </div>

                            <div className="difficulty-grid">
                                {Object.entries(difficulties).map(([key, diff]) => (
                                    <div
                                        key={key}
                                        className={`difficulty-btn ${difficulty === key ? 'selected' : ''}`}
                                        onClick={() => setDifficulty(key)}
                                    >
                                        <div style={{fontSize: '40px', marginBottom: '10px'}}>{diff.icon}</div>
                                        <div style={{fontSize: '18px', fontWeight: 'bold', marginBottom: '5px'}}>
                                            {diff.name}
                                        </div>
                                        <div style={{fontSize: '14px', opacity: 0.8}}>
                                            {diff.description}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <button 
                                className="start-btn" 
                                onClick={() => setGameState('lead-info')}
                                disabled={!officeName || !doctorName || !difficulty}
                            >
                                üë§ View Lead & Start Call
                            </button>

                            <div style={{marginTop: '20px', padding: '15px', background: '#fff3e0', borderRadius: '10px', fontSize: '14px'}}>
                                <strong>‚ö° Scenario:</strong> You're calling a patient who submitted an online inquiry form. 
                                Your goal is to build rapport, understand their needs, and book them for their first appointment.
                            </div>
                        </div>
                    </div>
                );
            }

            // LEAD INFO SCREEN - Shows patient details before call
            if (gameState === 'lead-info') {
                const lead = difficulties[difficulty];
                
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìã Lead Information</h1>
                            <p>Review before calling</p>
                        </div>
                        <div className="content">
                            <div style={{background: '#fff', border: '2px solid #16a085', borderRadius: '15px', padding: '25px', marginBottom: '20px'}}>
                                <div style={{display: 'flex', alignItems: 'center', marginBottom: '20px', borderBottom: '2px solid #f0f0f0', paddingBottom: '15px'}}>
                                    <div style={{fontSize: '50px', marginRight: '20px'}}>{lead.icon}</div>
                                    <div>
                                        <h2 style={{margin: 0, color: '#16a085'}}>{lead.leadName}</h2>
                                        <div style={{fontSize: '14px', color: '#666', marginTop: '5px'}}>
                                            Difficulty: <strong>{lead.name}</strong> - {lead.description}
                                        </div>
                                    </div>
                                </div>

                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px'}}>
                                    <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '10px'}}>
                                        <div style={{fontSize: '12px', color: '#666', marginBottom: '5px'}}>üìû PHONE</div>
                                        <div style={{fontSize: '18px', fontWeight: 'bold', color: '#2c3e50'}}>{lead.leadPhone}</div>
                                    </div>
                                    <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '10px'}}>
                                        <div style={{fontSize: '12px', color: '#666', marginBottom: '5px'}}>üìß EMAIL</div>
                                        <div style={{fontSize: '14px', fontWeight: 'bold', color: '#2c3e50', wordBreak: 'break-all'}}>{lead.leadEmail}</div>
                                    </div>
                                </div>

                                <div style={{background: '#fff3e0', padding: '15px', borderRadius: '10px', marginBottom: '20px'}}>
                                    <div style={{fontSize: '12px', color: '#666', marginBottom: '8px'}}>üè• HEALTH CONCERN</div>
                                    <div style={{fontSize: '16px', fontWeight: 'bold', color: '#f57c00'}}>{lead.healthConcern}</div>
                                </div>

                                <div style={{background: '#e3f2fd', padding: '15px', borderRadius: '10px'}}>
                                    <div style={{fontSize: '12px', color: '#666', marginBottom: '8px'}}>üìÖ FORM SUBMITTED</div>
                                    <div style={{fontSize: '16px', fontWeight: 'bold', color: '#1976d2'}}>{lead.formSubmitted}</div>
                                </div>
                            </div>

                            <div style={{background: '#e8f5e9', padding: '15px', borderRadius: '10px', marginBottom: '20px', fontSize: '14px'}}>
                                <strong>üìù Your Office Details:</strong>
                                <div style={{marginTop: '8px'}}>
                                    ‚Ä¢ Office: <strong>{officeName}</strong><br/>
                                    ‚Ä¢ Doctor: <strong>Dr. {doctorName}</strong>
                                    {vaName && <><br/>‚Ä¢ Your Name: <strong>{vaName}</strong></>}
                                </div>
                            </div>

                            <div style={{display: 'flex', gap: '10px'}}>
                                <button 
                                    className="start-btn" 
                                    onClick={startCall}
                                    style={{flex: 1, background: '#16a085'}}
                                >
                                    üìû Call {lead.leadName.split(' ')[0]} Now
                                </button>
                                <button 
                                    onClick={() => setGameState('setup')}
                                    style={{padding: '15px 25px', background: '#757575', color: 'white', border: 'none', borderRadius: '10px', cursor: 'pointer', fontSize: '16px', fontWeight: 'bold'}}
                                >
                                    ‚Üê Back
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // CALLING SCREEN
            if (gameState === 'calling') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Outbound Call in Progress</h1>
                            <p>Calling: {difficulties[difficulty].name} Patient</p>
                        </div>
                        <div className="content">
                            <div className={`status-box status-${currentStatus}`}>
                                {currentStatus === 'listening' && 'üëÇ Listening to you... (SPEAK CLEARLY AND SLOWLY)'}
                                {currentStatus === 'speaking' && 'üîä Patient speaking... (AI will wait 5 seconds after you stop)'}
                                {currentStatus === 'thinking' && 'üí≠ Processing...'}
                                {currentStatus === 'idle' && '‚è∏Ô∏è Ready - Start speaking when patient answers'}
                            </div>
                            
                            <div style={{padding: '15px', background: '#fff3e0', borderRadius: '10px', marginBottom: '15px', fontSize: '14px'}}>
                                <strong>üí° Tips for Better Call Quality:</strong>
                                <ul style={{marginLeft: '20px', marginTop: '8px'}}>
                                    <li><strong>Speak clearly</strong> at a moderate, steady pace</li>
                                    <li><strong>Pause 2-3 seconds</strong> between sentences</li>
                                    <li><strong>Avoid filler words</strong> like "um", "uh", "like" when possible</li>
                                    <li><strong>Use a headset microphone</strong> for best audio quality</li>
                                    <li>AI waits 5 full seconds after you stop before responding</li>
                                </ul>
                            </div>
                            
                            {interimText && (
                                <div style={{padding: '10px', background: '#e3f2fd', borderRadius: '8px', marginBottom: '15px', fontStyle: 'italic', border: '2px solid #2196f3'}}>
                                    <strong>Hearing you now:</strong> "{interimText}"
                                </div>
                            )}
                            
                            <div className="chat-container" ref={chatContainerRef}>
                                {messages.map((msg, i) => (
                                    <div key={i} className={`message ${msg.type}`}>
                                        {msg.type === 'staff' && <strong>You: </strong>}
                                        {msg.type === 'patient' && <strong>Patient: </strong>}
                                        {msg.text}
                                    </div>
                                ))}
                            </div>
                            
                            <button className="end-call-btn" onClick={endCall}>
                                ‚èπÔ∏è End Call & Get Score
                            </button>
                        </div>
                    </div>
                );
            }

            // SCORING SCREEN
            if (gameState === 'scoring') {
                // LOADING STATE - show while waiting for scoring
                if (!scoreData) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>‚è≥ Evaluating Your Call...</h1>
                                <p>Please wait</p>
                            </div>
                            <div className="content">
                                <div style={{padding: '40px', textAlign: 'center'}}>
                                    <div style={{fontSize: '48px', marginBottom: '20px'}}>üîÑ</div>
                                    <p style={{fontSize: '18px', marginBottom: '10px'}}>Analyzing conversation...</p>
                                    <p style={{fontSize: '14px', color: '#666'}}>This usually takes 5-10 seconds</p>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // ERROR STATE - if scoreData exists but has no scores
                if (!scoreData.scores) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>‚ö†Ô∏è Scoring Error</h1>
                                <p>Unable to score call</p>
                            </div>
                            <div className="content">
                                <div style={{padding: '20px', background: '#ffebee', borderRadius: '10px', marginBottom: '20px'}}>
                                    <p><strong>The scoring system encountered an error.</strong></p>
                                    <p style={{marginTop: '10px'}}>Error: {scoreData.summary || 'Unknown error'}</p>
                                    <p style={{marginTop: '10px'}}>This usually happens if:</p>
                                    <ul style={{marginLeft: '20px', marginTop: '10px'}}>
                                        <li>The call was too short</li>
                                        <li>There was a connection issue</li>
                                        <li>Your API key is invalid or out of credits</li>
                                    </ul>
                                </div>
                                <button className="start-btn" onClick={resetGame}>
                                    Try Another Call
                                </button>
                            </div>
                        </div>
                    );
                }
                
                // NORMAL SCORING DISPLAY
                const checkpointTotal = Object.values(scoreData.scores).reduce((sum, c) => sum + c.score, 0);
                const passed = scoreData.totalScore >= 70;
                
                // Format timestamps
                const formatDate = (date) => {
                    if (!date) return 'N/A';
                    return date.toLocaleString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };
                
                const calculateDuration = () => {
                    if (!callStartTime || !callEndTime) return 'N/A';
                    const durationMs = callEndTime - callStartTime;
                    const minutes = Math.floor(durationMs / 60000);
                    const seconds = Math.floor((durationMs % 60000) / 1000);
                    return `${minutes}m ${seconds}s`;
                };

                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìä Your Score</h1>
                            <p>{passed ? '‚úÖ PASSED' : '‚ùå NEEDS IMPROVEMENT'}</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                {/* Timestamp Information */}
                                <div style={{marginBottom: '20px', padding: '15px', background: '#f0f0f0', borderRadius: '10px', fontSize: '13px'}}>
                                    <div style={{marginBottom: '8px'}}><strong>Office:</strong> {officeName}</div>
                                    <div style={{marginBottom: '8px'}}><strong>Doctor:</strong> Dr. {doctorName}</div>
                                    {vaName && <div style={{marginBottom: '8px'}}><strong>VA Name:</strong> {vaName}</div>}
                                    <div style={{marginBottom: '8px'}}><strong>Difficulty:</strong> {difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</div>
                                    <div style={{marginBottom: '8px'}}><strong>Call Duration:</strong> {calculateDuration()}</div>
                                    <div style={{marginBottom: '8px'}}><strong>Completed:</strong> {formatDate(callEndTime)}</div>
                                </div>
                                
                                <div className="overall-score" style={{color: passed ? '#4caf50' : '#f44336'}}>
                                    {scoreData.totalScore}/100
                                </div>
                                
                                <div style={{textAlign: 'center', marginBottom: '20px', padding: '15px', background: scoreData.patientBooked ? '#e8f5e9' : '#ffebee', borderRadius: '10px'}}>
                                    <strong>{scoreData.patientBooked ? '‚úÖ Patient Booked Appointment!' : '‚ùå Patient Did Not Book'}</strong>
                                </div>
                                
                                {scoreData.summary && (
                                    <div style={{marginBottom: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                        <strong>Summary:</strong> {scoreData.summary}
                                    </div>
                                )}
                                
                                <h3 style={{marginBottom: '15px'}}>7 Checkpoints ({checkpointTotal}/70):</h3>
                                
                                {Object.entries(scoreData.scores).map(([key, data]) => {
                                    const labels = {
                                        introduction: 'Professional Introduction',
                                        healthHistory: 'Asked About Health History',
                                        purposeStated: 'Clearly Stated Purpose',
                                        appointmentOptions: 'Proposed Specific Times',
                                        objectionHandling: 'Handled Objections Well',
                                        paymentCollection: 'Collected Initial Payment',
                                        closingConfirmation: 'Confirmed & Closed Professionally'
                                    };
                                    
                                    return (
                                        <div key={key} className="score-item" style={{background: data.score >= 7 ? '#e8f5e9' : data.score >= 4 ? '#fff3e0' : '#ffebee'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <span>{data.score >= 7 ? '‚úÖ' : data.score >= 4 ? '‚ö†Ô∏è' : '‚ùå'} {labels[key]}</span>
                                                <strong>{data.score}/10</strong>
                                            </div>
                                            {data.note && <p style={{fontSize: '13px', color: '#666', marginTop: '5px'}}>{data.note}</p>}
                                        </div>
                                    );
                                })}
                                
                                {/* Bonus Points Breakdown */}
                                <div style={{marginTop: '15px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                    <strong>Bonus Points: {scoreData.bonus}/30</strong>
                                    
                                    {scoreData.bonusBreakdown && (
                                        <div style={{marginTop: '10px', fontSize: '13px'}}>
                                            <div style={{marginBottom: '5px'}}>
                                                ‚Ä¢ Communication Excellence: {scoreData.bonusBreakdown.communication || 0}/10
                                            </div>
                                            <div style={{marginBottom: '5px'}}>
                                                ‚Ä¢ Professionalism: {scoreData.bonusBreakdown.professionalism || 0}/10
                                            </div>
                                            <div style={{marginBottom: '5px'}}>
                                                ‚Ä¢ Problem Solving: {scoreData.bonusBreakdown.problemSolving || 0}/10
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {scoreData.positives?.filter(p => p).length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="positive">‚úÖ What You Did Well:</h4>
                                        <ul>{scoreData.positives.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                                
                                {scoreData.improvements?.filter(p => p).length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="negative">üìà Areas to Improve:</h4>
                                        <ul>{scoreData.improvements.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                                
                                {scoreData.criticalMisses?.filter(p => p).length > 0 && (
                                    <div className="feedback-section" style={{background: '#ffebee'}}>
                                        <h4 className="critical">üö® Critical Misses:</h4>
                                        <ul>{scoreData.criticalMisses.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                            </div>
                            
                            <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Another Call</button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
