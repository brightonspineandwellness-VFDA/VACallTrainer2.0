<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiro Voice Training 2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 40px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .difficulty-btn {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .difficulty-btn:hover { border-color: #667eea; transform: translateY(-2px); }
        .difficulty-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .start-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-container {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.staff { background: #667eea; color: white; margin-left: auto; }
        .message.patient { background: white; border: 1px solid #ddd; }
        .message.system { background: #ffc107; text-align: center; max-width: 100%; }
        .end-call-btn {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .score-card { background: #f9f9f9; border-radius: 15px; padding: 25px; }
        .overall-score {
            font-size: 64px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .score-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status-listening { background: #e8f5e9; color: #2e7d32; }
        .status-speaking { background: #e3f2fd; color: #1565c0; }
        .status-thinking { background: #fff3e0; color: #ef6c00; }
        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        .feedback-section h4 { margin-bottom: 10px; color: #333; }
        .feedback-section ul { margin-left: 20px; }
        .feedback-section li { margin-bottom: 5px; }
        .positive { color: #2e7d32; }
        .negative { color: #c62828; }
        .critical { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const APP_PASSWORD = "ChiroTrain2025";
        const STORED_KEY = localStorage.getItem('openai_api_key');

        // Patient personas - OUTSIDE component to avoid closure issues
        const PATIENT_PERSONAS = {
            easy: {
                name: 'Sarah Johnson',
                phone: '555-867-5309',
                email: 'sarah.johnson@email.com',
                problem: 'back pain for about 2 weeks',
                availability: 'this week, mornings are best',
                referral: 'a friend recommended you'
            },
            challenging: {
                name: 'Mike Davis',
                phone: '555-234-5678',
                email: 'mike.davis@email.com',
                problem: 'neck pain and stiffness',
                availability: 'flexible, any day works',
                referral: 'found you on Google',
                insurance: 'Blue Cross Blue Shield'
            }
        };

        // Expanded question pool for challenging mode
        const CHALLENGING_QUESTIONS = [
            {
                id: 'cost',
                question: 'How much does the first visit cost?',
                checkAnswer: (vaText) => vaText.includes('$') || vaText.includes('dollar') || vaText.includes('49') || vaText.includes('59') || vaText.match(/\d+/) || vaText.includes('varies') || vaText.includes('discuss')
            },
            {
                id: 'insurance',
                question: 'Do you accept Blue Cross Blue Shield insurance?',
                checkAnswer: (vaText) => vaText.includes('insurance') || vaText.includes('blue cross') || vaText.includes('programs') || vaText.includes('work with') || vaText.includes('bring your card') || vaText.includes('verify')
            },
            {
                id: 'duration',
                question: 'How long does the appointment usually take?',
                checkAnswer: (vaText) => vaText.includes('30') || vaText.includes('45') || vaText.includes('minute') || vaText.includes('hour')
            },
            {
                id: 'bring',
                question: 'What do I need to bring?',
                checkAnswer: (vaText) => vaText.includes('bring') || vaText.includes('insurance card') || vaText.includes('x-ray') || vaText.includes('mri') || vaText.includes('id')
            },
            {
                id: 'includes',
                question: 'What does the first visit include?',
                checkAnswer: (vaText) => vaText.includes('consultation') || vaText.includes('exam') || vaText.includes('adjustment') || vaText.includes('include')
            },
            {
                id: 'thisweek',
                question: 'Can I get an appointment this week?',
                checkAnswer: (vaText) => vaText.includes('week') || vaText.includes('monday') || vaText.includes('tuesday') || vaText.includes('available') || vaText.includes('schedule')
            },
            {
                id: 'decompression',
                question: 'Do you do decompression therapy for neck pain?',
                checkAnswer: (vaText) => vaText.includes('decompression') || vaText.includes('therapy') || vaText.includes('doctor') || vaText.includes('appointment') || vaText.includes('discuss')
            },
            {
                id: 'laser',
                question: 'Do you do laser therapy?',
                checkAnswer: (vaText) => vaText.includes('laser') || vaText.includes('therapy') || vaText.includes('doctor') || vaText.includes('appointment') || vaText.includes('discuss')
            }
        ];

        // Helper function to select random questions for challenging mode
        function selectRandomQuestions() {
            const numQuestions = Math.random() < 0.5 ? 2 : 3; // Random 2 or 3
            const shuffled = [...CHALLENGING_QUESTIONS].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, numQuestions);
        }

        // Helper function to check if VA response indicates call ending
        function isGoodbyePhrase(text) {
            const lower = text.toLowerCase();
            const goodbyePhrases = [
                'goodbye',
                'bye bye',
                'see you',
                'have a great day',
                'have a nice day',
                'talk to you later',
                'thank you, bye'
            ];
            
            return goodbyePhrases.some(phrase => lower.includes(phrase));
        }

        // Helper function to generate patient goodbye response
        function getPatientGoodbye() {
            const goodbyes = [
                'Goodbye!',
                'Thank you!',
                'Thank you, goodbye!',
                'Perfect, thank you, bye!',
                'Great, thank you, bye!',
                'Sounds good, goodbye!'
            ];
            
            return goodbyes[Math.floor(Math.random() * goodbyes.length)];
        }

        function ChiroVoiceTrainer() {
            const [isAuthenticated, setIsAuthenticated] = useState(sessionStorage.getItem('auth') === 'true');
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [apiKey, setApiKey] = useState(STORED_KEY || '');
            const [showApiPrompt, setShowApiPrompt] = useState(!STORED_KEY);
            const [gameState, setGameState] = useState('setup');
            
            // Form fields
            const [officeName, setOfficeName] = useState('');
            const [doctorName, setDoctorName] = useState('');
            const [firstVisitCost, setFirstVisitCost] = useState('');
            const [vaName, setVaName] = useState('');
            
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [scoreData, setScoreData] = useState(null);
            const [interimText, setInterimText] = useState('');

            // Use REFS for values needed in async callbacks to avoid stale closures
            const conversationRef = useRef([]);
            const difficultyRef = useRef('');
            const apiKeyRef = useRef('');
            const officeNameRef = useRef('');
            const doctorNameRef = useRef('');
            const firstVisitCostRef = useRef('');
            const selectedQuestionsRef = useRef([]);
            
            const recognitionRef = useRef(null);
            const shouldListenRef = useRef(false);
            const isProcessingRef = useRef(false);
            const silenceTimerRef = useRef(null);
            const lastTranscriptRef = useRef('');
            const audioRef = useRef(null);
            const callEndingRef = useRef(false);

            // Keep refs in sync with state
            useEffect(() => { difficultyRef.current = difficulty; }, [difficulty]);
            useEffect(() => { apiKeyRef.current = apiKey; }, [apiKey]);
            useEffect(() => { officeNameRef.current = officeName; }, [officeName]);
            useEffect(() => { doctorNameRef.current = doctorName; }, [doctorName]);
            useEffect(() => { firstVisitCostRef.current = firstVisitCost; }, [firstVisitCost]);

            const checkPassword = () => {
                if (passwordInput === APP_PASSWORD) {
                    sessionStorage.setItem('auth', 'true');
                    setIsAuthenticated(true);
                } else {
                    setPasswordError('Wrong password');
                    setPasswordInput('');
                }
            };

            const saveApiKey = () => {
                localStorage.setItem('openai_api_key', apiKey);
                setShowApiPrompt(false);
            };

            // Build prompt based on difficulty and conversation
            const buildPrompt = () => {
                const diff = difficultyRef.current;
                const conversation = conversationRef.current;
                const persona = PATIENT_PERSONAS[diff] || PATIENT_PERSONAS.easy;
                
                console.log('=== BUILD PROMPT ===');
                console.log('Difficulty from ref:', diff);
                console.log('Persona:', persona);
                
                // Build conversation text
                let convoText = conversation.map(m => `${m.speaker}: ${m.text}`).join('\n');
                
                // Count patient turns
                const patientTurns = conversation.filter(m => m.speaker === 'PATIENT').length;
                const isFirstResponse = patientTurns === 0;

                // Check if VA just said goodbye
                const lastVAMessage = conversation.length > 0 && conversation[conversation.length - 1].speaker === 'VA' 
                    ? conversation[conversation.length - 1].text 
                    : '';
                
                if (isGoodbyePhrase(lastVAMessage)) {
                    return `You are ending a phone call. The receptionist just said goodbye to you.

Respond with ONLY one of these goodbye phrases:
- "Goodbye!"
- "Thank you!"
- "Thank you, goodbye!"
- "Perfect, thank you, bye!"

Pick one randomly. Say nothing else. No additional text.`;
                }

                // ==================== EASY MODE ====================
                if (diff === 'easy') {
                    if (isFirstResponse) {
                        return `You are Sarah Johnson, calling a chiropractic office to book an appointment for back pain.

The receptionist just answered. Say you want to schedule an appointment.

Say exactly: "Hi, I'd like to schedule an appointment. I've been having some back pain for about 2 weeks."`;
                    }

                    // Detect what information VA is REQUESTING (not just mentioning)
                    // Only respond with info if VA is ASKING for it, not just confirming/informing
                    const lastVAMessage = conversation.length > 0 && conversation[conversation.length - 1].speaker === 'VA' 
                        ? conversation[conversation.length - 1].text.toLowerCase()
                        : '';
                    
                    const askingForEmail = (
                        (lastVAMessage.includes('email') && 
                        (lastVAMessage.includes('can i have') || 
                         lastVAMessage.includes('what is') || 
                         lastVAMessage.includes('what\'s') ||
                         lastVAMessage.includes('whats') ||
                         lastVAMessage.includes('may i have') ||
                         lastVAMessage.includes('i need') ||
                         lastVAMessage.includes('give me') ||
                         lastVAMessage.includes('send to') ||
                         lastVAMessage.includes('best email') ||
                         lastVAMessage.includes('your email'))) &&
                        !lastVAMessage.includes('sending') &&
                        !lastVAMessage.includes('send it to') &&
                        !lastVAMessage.includes('will send') &&
                        !lastVAMessage.includes('i\'ll send')
                    );
                    
                    const askingForPhone = (
                        (lastVAMessage.includes('phone') || lastVAMessage.includes('number')) && 
                        (lastVAMessage.includes('can i have') || 
                         lastVAMessage.includes('what is') || 
                         lastVAMessage.includes('what\'s') ||
                         lastVAMessage.includes('whats') ||
                         lastVAMessage.includes('may i have') ||
                         lastVAMessage.includes('i need') ||
                         lastVAMessage.includes('give me') ||
                         lastVAMessage.includes('best number') ||
                         lastVAMessage.includes('your phone') ||
                         lastVAMessage.includes('your number'))
                    );
                    
                    const askingForName = (
                        lastVAMessage.includes('name') && 
                        !askingForEmail && 
                        !askingForPhone &&
                        (lastVAMessage.includes('can i have') || 
                         lastVAMessage.includes('what is') || 
                         lastVAMessage.includes('what\'s') ||
                         lastVAMessage.includes('whats') ||
                         lastVAMessage.includes('may i have') ||
                         lastVAMessage.includes('i need') ||
                         lastVAMessage.includes('give me') ||
                         lastVAMessage.includes('full name') ||
                         lastVAMessage.includes('your name'))
                    );
                    
                    const askingForReferral = lastVAMessage.includes('hear about') || lastVAMessage.includes('find us') || lastVAMessage.includes('how did you');
                    const askingForAvailability = lastVAMessage.includes('availability') || lastVAMessage.includes('earlier') || lastVAMessage.includes('later') || lastVAMessage.includes('morning') || lastVAMessage.includes('afternoon');

                    return `You are Sarah Johnson, a friendly patient on a phone call with a chiropractic office.

YOUR PERSONAL INFO (use these EXACT values when asked):
- Your name: Sarah Johnson
- Your phone number: 555-867-5309
- Your email: sarah.johnson@email.com
- Your problem: back pain for about 2 weeks
- Your availability: this week, mornings are best
- How you heard about them: a friend recommended you

CONVERSATION SO FAR:
${convoText}

VA'S LAST MESSAGE: "${lastVAMessage}"

INSTRUCTIONS - ANSWER WHAT VA ASKED FOR:
${askingForName ? '- VA is asking for your NAME. Say ONLY: "Sarah Johnson"' : ''}
${askingForEmail && askingForPhone ? '- VA is asking for your EMAIL AND PHONE. Say: "My email is sarah.johnson@email.com and my phone number is 555-867-5309"' : ''}
${askingForEmail && !askingForPhone ? '- VA is asking for your EMAIL only. Say ONLY: "sarah.johnson@email.com"' : ''}
${askingForPhone && !askingForEmail ? '- VA is asking for your PHONE only. Say ONLY: "555-867-5309"' : ''}
${askingForReferral ? '- VA is asking HOW YOU HEARD about them. Say ONLY: "A friend recommended you"' : ''}
${askingForAvailability ? '- VA is asking about AVAILABILITY. Say ONLY: "This week, mornings are best" or answer their specific question about morning/afternoon/early/late' : ''}
${!askingForName && !askingForEmail && !askingForPhone && !askingForReferral && !askingForAvailability ? '- If they offer an appointment time: Say "Yes, that works for me" or "Perfect"\n- If they explain fees or what\'s included: Say "Okay, sounds good"\n- If they inform you about sending forms/emails: Say "Okay, thank you" or "Sounds good"\n- Otherwise, respond naturally and cooperatively to what they said' : ''}

CRITICAL: Only give your email/phone when VA is ASKING for it, not when they're just mentioning sending something to it.
DO NOT say your name unless they specifically ask for your name.
DO NOT say your email/phone when VA is just informing you about sending something.
DO NOT repeat information you already gave.
ONLY answer the specific question they just asked.

Give a short 1-2 sentence response. Be friendly and cooperative. Do not add labels or quotes.`;
                }

                // ==================== CHALLENGING MODE ====================
                if (diff === 'challenging') {
                    const selectedQuestions = selectedQuestionsRef.current;
                    
                    if (isFirstResponse) {
                        // First question is now random from the selected questions
                        const firstQuestion = selectedQuestions[0];
                        return `You are Mike Davis, calling a chiropractic office. You want to book but need some info first.

The receptionist just answered. Ask your first question.

Say exactly: "Hi, I'd like to schedule an appointment, but first - ${firstQuestion.question}"`;
                    }

                    // Check what VA has mentioned and how they responded
                    const vaMessages = conversation.filter(m => m.speaker === 'VA');
                    const vaText = vaMessages.map(m => m.text.toLowerCase()).join(' ');
                    const lastVAMessage = vaMessages.length > 0 ? vaMessages[vaMessages.length - 1].text.toLowerCase() : '';
                    
                    // Track questions asked and answered
                    const patientMessages = conversation.filter(m => m.speaker === 'PATIENT');
                    const patientText = patientMessages.map(m => m.text.toLowerCase()).join(' ');
                    const questionsAsked = patientMessages.length;
                    
                    // Check which questions have been answered
                    const answeredQuestions = selectedQuestions.filter(q => q.checkAnswer(vaText));
                    
                    // Check for RED FLAG responses (refuse to book if these happen)
                    const vaIgnoredQuestion = lastVAMessage.length < 10 && !lastVAMessage.includes('yes') && !lastVAMessage.includes('no');
                    const vaPuntedToOthers = lastVAMessage.includes('let me ask') || lastVAMessage.includes('check with') || lastVAMessage.includes('someone else') || lastVAMessage.includes('not sure');
                    const vaVagueAboutInclusions = (patientMessages.some(p => p.text.toLowerCase().includes('include')) && (lastVAMessage.includes('figure it out') || lastVAMessage.includes('see when you come')));
                    
                    // Check if patient has already said they're ready to book OR asked about appointment availability
                    const patientSaidReadyToBook = patientMessages.some(p => {
                        const text = p.text.toLowerCase();
                        return text.includes("ready to book") || 
                               text.includes("let's book") || 
                               text.includes("book the appointment");
                    });
                    
                    // Check if patient asked about scheduling/appointments (indicates readiness)
                    const patientAskedAboutAppointments = patientMessages.some(p => {
                        const text = p.text.toLowerCase();
                        return text.includes("appointment this week") || 
                               text.includes("get an appointment") ||
                               text.includes("schedule this week") ||
                               text.includes("available this week");
                    });

                    // If questions answered and ready to book (either explicitly or by asking about appointments), become like Easy mode
                    const questionsAnswered = questionsAsked >= selectedQuestions.length && !vaPuntedToOthers && !vaVagueAboutInclusions && !vaIgnoredQuestion;
                    const readyToBook = patientSaidReadyToBook || (questionsAnswered && patientAskedAboutAppointments);

                    if (questionsAnswered && readyToBook) {
                        // SWITCH TO EASY MODE BEHAVIOR
                        // Check if VA is offering multiple time slots
                        const timeSlotPattern = /(\d{1,2})\s*(am|pm|a\.m|p\.m)/gi;
                        const timeMatches = lastVAMessage.match(timeSlotPattern);
                        
                        if (timeMatches && timeMatches.length >= 2) {
                            // VA offered multiple times - pick one randomly
                            const randomTime = timeMatches[Math.floor(Math.random() * timeMatches.length)];
                            return `The VA just offered you multiple appointment times. Pick ONE specific time.

CONVERSATION SO FAR:
${convoText}

The VA's last message mentioned these times: ${timeMatches.join(', ')}

Pick ONE time randomly and respond with ONLY that choice.

Examples of good responses:
- "${randomTime} works great for me"
- "I'll take ${randomTime}"
- "${randomTime} is perfect"
- "Let's do ${randomTime}"

Pick one of these response styles randomly. Say nothing else.`;
                        }
                        
                        // Detect what information VA is REQUESTING (not just mentioning)
                        // Only respond with info if VA is ASKING for it, not just confirming/informing
                        const askingForEmail = (
                            (lastVAMessage.includes('email') && 
                            (lastVAMessage.includes('can i have') || 
                             lastVAMessage.includes('what is') || 
                             lastVAMessage.includes('what\'s') ||
                             lastVAMessage.includes('whats') ||
                             lastVAMessage.includes('may i have') ||
                             lastVAMessage.includes('i need') ||
                             lastVAMessage.includes('give me') ||
                             lastVAMessage.includes('send to') ||
                             lastVAMessage.includes('best email') ||
                             lastVAMessage.includes('your email'))) &&
                            !lastVAMessage.includes('sending') &&
                            !lastVAMessage.includes('send it to') &&
                            !lastVAMessage.includes('will send') &&
                            !lastVAMessage.includes('i\'ll send')
                        );
                        
                        const askingForPhone = (
                            (lastVAMessage.includes('phone') || lastVAMessage.includes('number')) && 
                            (lastVAMessage.includes('can i have') || 
                             lastVAMessage.includes('what is') || 
                             lastVAMessage.includes('what\'s') ||
                             lastVAMessage.includes('whats') ||
                             lastVAMessage.includes('may i have') ||
                             lastVAMessage.includes('i need') ||
                             lastVAMessage.includes('give me') ||
                             lastVAMessage.includes('best number') ||
                             lastVAMessage.includes('your phone') ||
                             lastVAMessage.includes('your number'))
                        );
                        
                        const askingForName = (
                            lastVAMessage.includes('name') && 
                            !askingForEmail && 
                            !askingForPhone &&
                            (lastVAMessage.includes('can i have') || 
                             lastVAMessage.includes('what is') || 
                             lastVAMessage.includes('what\'s') ||
                             lastVAMessage.includes('whats') ||
                             lastVAMessage.includes('may i have') ||
                             lastVAMessage.includes('i need') ||
                             lastVAMessage.includes('give me') ||
                             lastVAMessage.includes('full name') ||
                             lastVAMessage.includes('your name'))
                        );
                        
                        const askingForReferral = lastVAMessage.includes('hear about') || lastVAMessage.includes('find us') || lastVAMessage.includes('how did you');
                        const askingForAvailability = lastVAMessage.includes('availability') || lastVAMessage.includes('earlier') || lastVAMessage.includes('later') || lastVAMessage.includes('morning') || lastVAMessage.includes('afternoon');
                        
                        return `You are Mike Davis, a patient on a phone call with a chiropractic office. You've asked your questions and you're ready to book.

YOUR PERSONAL INFO (use these EXACT values when asked):
- Your name: Mike Davis
- Your phone number: 555-234-5678
- Your email: mike.davis@email.com
- Your availability: flexible, any day works
- How you heard about them: found you on Google

CONVERSATION SO FAR:
${convoText}

VA'S LAST MESSAGE: "${lastVAMessage}"

CRITICAL INSTRUCTIONS - ANSWER WHAT VA ASKED FOR:
${askingForName ? '- VA is asking for your NAME. Say ONLY: "Mike Davis"' : ''}
${askingForEmail && askingForPhone ? '- VA is asking for your EMAIL AND PHONE. Say: "My email is mike.davis@email.com and my phone number is 555-234-5678"' : ''}
${askingForEmail && !askingForPhone ? '- VA is asking for your EMAIL only. Say ONLY: "mike.davis@email.com"' : ''}
${askingForPhone && !askingForEmail ? '- VA is asking for your PHONE only. Say ONLY: "555-234-5678"' : ''}
${askingForReferral ? '- VA is asking HOW YOU HEARD about them. Say ONLY: "I found you on Google"' : ''}
${askingForAvailability ? '- VA is asking about AVAILABILITY/TIME preference. Say ONLY: "Flexible, any day works" or answer their specific question about morning/afternoon/early/late' : ''}
${!askingForName && !askingForEmail && !askingForPhone && !askingForReferral && !askingForAvailability ? '- If they offer an appointment time: Say "Yes, that works for me" or "Perfect, I\'ll be there"\n- If they confirm details or inform about sending forms: Say "Perfect, thank you!" or "Sounds good"\n- Otherwise, respond naturally to what they said' : ''}

CRITICAL: Only give your email/phone when VA is ASKING for it, not when they're just mentioning sending something to it.
DO NOT say your email/phone when VA is just informing you about sending something.
DO NOT repeat information you already gave.
DO NOT say your name unless they specifically ask for your name.
ONLY answer the specific question they just asked.

Give a short 1-2 sentence response. Be friendly and cooperative.`;
                    }

                    // Build list of questions to ask
                    const questionsToAsk = selectedQuestions.map((q, idx) => 
                        `${idx + 1}. ${q.question}`
                    ).join('\n');

                    // Build status of answered questions
                    const questionStatus = selectedQuestions.map((q, idx) => 
                        answeredQuestions.includes(q) ? `âœ“ Question ${idx + 1} answered` : ''
                    ).filter(s => s).join('\n');

                    return `You are Mike Davis, a patient calling a chiropractic office. You want to book but have a few quick questions first.

YOUR PERSONAL INFO (use these EXACT values when asked):
- Your name: Mike Davis
- Your phone number: 555-234-5678
- Your email: mike.davis@email.com
- Your problem: neck pain and stiffness
- Your availability: flexible, any day works
- How you heard about them: found you on Google
- Your insurance: Blue Cross Blue Shield

CONVERSATION SO FAR:
${convoText}

YOUR QUESTIONS TO ASK (in order):
${questionsToAsk}

STATUS:
- Questions you've asked so far: ${questionsAsked}
${questionStatus}

CRITICAL RULES:
${vaPuntedToOthers ? 'RED FLAG: VA is punting to someone else instead of answering. Say: "I appreciate your time, but I need answers now. I\'ll think about it. Goodbye." (DO NOT BOOK)' : ''}
${vaVagueAboutInclusions ? 'RED FLAG: VA was vague about what\'s included. Say: "I need to know what I\'m paying for. I\'ll call back later. Goodbye." (DO NOT BOOK)' : ''}
${vaIgnoredQuestion && questionsAsked > 1 ? 'RED FLAG: VA ignored your question. Say: "This isn\'t working out. I\'ll look elsewhere. Goodbye." (DO NOT BOOK)' : ''}

${questionsAnswered ? 'You\'ve asked all your questions and VA answered them well. If you asked about appointment availability, you\'re ready to book. Otherwise say: "Great, thank you for answering my questions. I\'m ready to book the appointment." Then STOP asking questions and wait for VA to guide you through booking.' : `Ask the NEXT question from your list (Question ${questionsAsked + 1}) if you haven't asked it yet.`}

ACCEPTABLE VA ANSWERS:
- Cost: Any range ($49-59), exact number ($59), or "varies/we'll discuss" = ALL GOOD
- Insurance: "We work with all types", "bring your card", or even "we don't take insurance" = ALL GOOD
- What's included: "Consultation, exam, adjustment" or similar = GOOD
- In-depth medical questions (decompression, laser): VA redirecting to doctor/booking = GOOD

DO NOT give all your information at once unless VA specifically asks for it.

Give a short 1-2 sentence response. Be polite and friendly.`;
                }

                // Fallback
                return `You are a patient calling a chiropractic office. The conversation so far: ${convoText}. Respond naturally in one sentence.`;
            };

            // Call OpenAI API
            const getPatientResponse = async () => {
                const prompt = buildPrompt();
                const key = apiKeyRef.current;
                
                console.log('=== API CALL ===');
                console.log('Prompt:', prompt);
                
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 150,
                            temperature: 0.7
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error('API Error:', data.error);
                        return "Sorry, could you repeat that?";
                    }
                    
                    let reply = data.choices[0].message.content.trim();
                    reply = reply.replace(/^(PATIENT:|Patient:|Me:|Caller:)\s*/i, '');
                    reply = reply.replace(/^["']|["']$/g, '');
                    
                    console.log('Patient reply:', reply);
                    return reply;
                } catch (error) {
                    console.error('Fetch error:', error);
                    return "I'm sorry, could you say that again?";
                }
            };

            // Evaluation
            const evaluateCall = async () => {
                const conversation = conversationRef.current;
                const convoText = conversation.map(m => `${m.speaker}: ${m.text}`).join('\n');
                const key = apiKeyRef.current;
                const diff = difficultyRef.current;
                const office = officeNameRef.current;
                const doctor = doctorNameRef.current;
                const cost = firstVisitCostRef.current;
                
                const evalPrompt = `Evaluate this VA's phone call performance at a chiropractic office.

CORRECT OFFICE INFO (what VA should have said):
- OFFICE NAME: ${office}
- DOCTOR NAME: Dr. ${doctor}
- FIRST VISIT COST: $${cost}

DIFFICULTY MODE: ${diff.toUpperCase()}

FULL CALL TRANSCRIPT:
${convoText}

EVALUATION CRITERIA - Score each 0-10:

1. GREETING & INTRODUCTION (0-10):
   - Did VA introduce themselves with their name?
   - Did VA say the office name (give full credit even if speech recognition misheard the exact pronunciation, as long as they attempted to say the office name)?
   - Professional and friendly tone?
   - NOTE: The transcript may contain speech recognition errors. Focus on whether the VA clearly ATTEMPTED to say the office name, even if the transcription shows errors.

2. REASON FOR CALL (0-10):
   - Did VA identify why patient called (pain complaint, appointment request)?
   - Did they acknowledge it appropriately?

3. SCHEDULING & TIME (0-10):
   - Did VA offer specific appointment date/time?
   - Did they confirm the appointment clearly?
   - Did they ask about patient's time preferences?

4. PATIENT INFORMATION (0-10):
   - Did VA collect full name?
   - Did VA collect phone number?
   - Did VA collect email address?

5. REFERRAL SOURCE (0-10):
   - Did VA ask how patient heard about the office?
   - Did they note the response?

6. FEE EXPLANATION (0-10):
   - Did VA mention the first visit cost (should be $${cost})?
   - Did VA explain what's included (consultation, exam, adjustment)?
   - Clear and confident explanation?

7. PROFESSIONAL CLOSING (0-10):
   - Did VA summarize the appointment details?
   - Did VA end warmly and professionally?
   - Did they say goodbye appropriately?

BONUS POINTS (0-30):
- Natural conversational flow
- Handling questions smoothly
- Professional tone throughout
- No awkward pauses or confusion
- Personalization and warmth

IMPORTANT: Be lenient with office name pronunciation in the greeting. If the VA clearly attempted to say an office name in their greeting (even if the speech recognition transcribed it incorrectly), give them credit for introducing the office.

Return ONLY valid JSON (no markdown, no code blocks):
{
    "scores": {
        "greeting": {"score": 0, "note": ""},
        "reason": {"score": 0, "note": ""},
        "scheduling": {"score": 0, "note": ""},
        "patientInfo": {"score": 0, "note": ""},
        "referral": {"score": 0, "note": ""},
        "feeExplanation": {"score": 0, "note": ""},
        "closing": {"score": 0, "note": ""}
    },
    "bonus": 0,
    "totalScore": 0,
    "positives": [""],
    "improvements": [""],
    "criticalMisses": [""],
    "patientBooked": true,
    "summary": ""
}`;

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{ role: 'user', content: evalPrompt }],
                            max_tokens: 800,
                            temperature: 0.3
                        })
                    });
                    
                    const data = await response.json();
                    let content = data.choices[0].message.content.trim();
                    content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    return JSON.parse(content);
                } catch (error) {
                    console.error('Eval error:', error);
                    return null;
                }
            };

            const playAudio = async (text) => {
                setCurrentStatus('speaking');
                shouldListenRef.current = false;
                
                try {
                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKeyRef.current}`
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            input: text,
                            voice: 'nova'
                        })
                    });
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audioRef.current = audio;
                    
                    audio.onended = () => {
                        // Check if this was a goodbye response
                        if (isGoodbyePhrase(text) || callEndingRef.current) {
                            // Patient said goodbye - end the call
                            console.log('Call ending detected - patient said goodbye');
                            callEndingRef.current = true;
                            setTimeout(() => endCall(), 1000);
                        } else {
                            setCurrentStatus('listening');
                            shouldListenRef.current = true;
                            startListening();
                        }
                    };
                    
                    await audio.play();
                } catch (error) {
                    console.error('Audio error:', error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
            };

            const startListening = () => {
                if (recognitionRef.current && shouldListenRef.current) {
                    try {
                        recognitionRef.current.start();
                    } catch (e) {}
                }
            };

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }

                        if (interim) setInterimText(interim);
                        
                        if (final && shouldListenRef.current && !isProcessingRef.current) {
                            if (silenceTimerRef.current) clearTimeout(silenceTimerRef.current);
                            
                            lastTranscriptRef.current = (lastTranscriptRef.current + ' ' + final).trim();
                            setInterimText(lastTranscriptRef.current);
                            
                            silenceTimerRef.current = setTimeout(() => {
                                if (lastTranscriptRef.current && shouldListenRef.current) {
                                    handleVAResponse(lastTranscriptRef.current);
                                    lastTranscriptRef.current = '';
                                    setInterimText('');
                                }
                            }, 1500);
                        }
                    };

                    recognitionRef.current.onend = () => {
                        if (shouldListenRef.current && !callEndingRef.current) {
                            setTimeout(() => {
                                try { recognitionRef.current.start(); } catch (e) {}
                            }, 100);
                        }
                    };
                }
            }, []);

            const startCall = () => {
                if (!difficulty || !officeName || !doctorName || !firstVisitCost) return;
                
                // Select random questions for challenging mode
                if (difficulty === 'challenging') {
                    selectedQuestionsRef.current = selectRandomQuestions();
                    console.log('Selected questions:', selectedQuestionsRef.current.map(q => q.question));
                }
                
                // Reset
                conversationRef.current = [];
                setMessages([]);
                setGameState('playing');
                callEndingRef.current = false;
                
                // Update refs immediately
                difficultyRef.current = difficulty;
                apiKeyRef.current = apiKey;
                officeNameRef.current = officeName;
                doctorNameRef.current = doctorName;
                firstVisitCostRef.current = firstVisitCost;
                
                console.log('=== CALL STARTED ===');
                console.log('Difficulty set to:', difficulty);
                console.log('Difficulty ref:', difficultyRef.current);
                
                setMessages([{ type: 'system', text: 'ðŸ“ž Incoming call! Answer with your greeting...' }]);
                setCurrentStatus('listening');
                shouldListenRef.current = true;
                
                setTimeout(() => startListening(), 500);
            };

            const handleVAResponse = async (transcript) => {
                if (isProcessingRef.current || callEndingRef.current) return;
                isProcessingRef.current = true;
                shouldListenRef.current = false;
                
                if (recognitionRef.current) {
                    try { recognitionRef.current.stop(); } catch (e) {}
                }
                
                setCurrentStatus('thinking');
                
                conversationRef.current.push({ speaker: 'VA', text: transcript });
                setMessages(prev => [...prev, { type: 'staff', text: transcript }]);
                
                // Check if VA is saying goodbye
                if (isGoodbyePhrase(transcript)) {
                    console.log('Goodbye phrase detected from VA:', transcript);
                    callEndingRef.current = true;
                }
                
                try {
                    const patientReply = await getPatientResponse();
                    
                    conversationRef.current.push({ speaker: 'PATIENT', text: patientReply });
                    setMessages(prev => [...prev, { type: 'patient', text: patientReply }]);
                    
                    await playAudio(patientReply);
                } catch (error) {
                    console.error('Error:', error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
                
                isProcessingRef.current = false;
            };

            const endCall = async () => {
                shouldListenRef.current = false;
                callEndingRef.current = true;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                
                setCurrentStatus('thinking');
                setMessages(prev => [...prev, { type: 'system', text: 'ðŸ“Š Evaluating...' }]);
                
                const evalResult = await evaluateCall();
                
                if (evalResult) {
                    setScoreData(evalResult);
                } else {
                    setScoreData({
                        scores: {
                            greeting: { score: 5, note: 'Evaluation unavailable' },
                            reason: { score: 5, note: '' },
                            scheduling: { score: 5, note: '' },
                            patientInfo: { score: 5, note: '' },
                            referral: { score: 5, note: '' },
                            feeExplanation: { score: 5, note: '' },
                            closing: { score: 5, note: '' }
                        },
                        bonus: 15,
                        totalScore: 50,
                        positives: ['Call completed'],
                        improvements: ['Try again'],
                        criticalMisses: [],
                        patientBooked: true,
                        summary: 'Evaluation unavailable'
                    });
                }
                
                setGameState('scoring');
            };

            const resetGame = () => {
                shouldListenRef.current = false;
                callEndingRef.current = false;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                conversationRef.current = [];
                selectedQuestionsRef.current = [];
                setGameState('setup');
                setDifficulty('');
                setMessages([]);
                setScoreData(null);
                setCurrentStatus('idle');
            };

            const canStart = officeName && doctorName && firstVisitCost && difficulty;

            // PASSWORD SCREEN
            if (!isAuthenticated) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>ðŸ” Chiro Voice Training</h1>
                            <p>Enter password to access</p>
                        </div>
                        <div className="content" style={{textAlign: 'center'}}>
                            <input 
                                type="password"
                                placeholder="Password"
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && checkPassword()}
                                style={{padding: '15px', fontSize: '16px', width: '100%', maxWidth: '300px', marginBottom: '15px', borderRadius: '10px', border: '2px solid #667eea'}}
                            />
                            {passwordError && <p style={{color: 'red', marginBottom: '15px'}}>{passwordError}</p>}
                            <br/>
                            <button className="start-btn" style={{maxWidth: '300px'}} onClick={checkPassword}>Access</button>
                        </div>
                    </div>
                );
            }

            // API KEY PROMPT
            if (showApiPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>ðŸ”‘ OpenAI API Key</h1>
                            <p>Enter your API key to use voice features</p>
                        </div>
                        <div className="content">
                            <div className="form-group">
                                <label>API Key</label>
                                <input 
                                    type="password"
                                    placeholder="sk-..."
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                />
                            </div>
                            <button className="start-btn" onClick={saveApiKey} disabled={!apiKey}>Save & Continue</button>
                        </div>
                    </div>
                );
            }

            // SETUP SCREEN
            if (gameState === 'setup') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>ðŸŽ¯ Chiro Voice Training 2.0</h1>
                            <p>Practice your phone skills with AI patients</p>
                        </div>
                        <div className="content">
                            <h3 style={{marginBottom: '20px'}}>Office Information:</h3>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Office Name *</label>
                                    <input 
                                        type="text"
                                        placeholder="Smith Chiropractic"
                                        value={officeName}
                                        onChange={(e) => setOfficeName(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Doctor's Last Name *</label>
                                    <input 
                                        type="text"
                                        placeholder="Smith"
                                        value={doctorName}
                                        onChange={(e) => setDoctorName(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>First Visit Cost ($) *</label>
                                    <input 
                                        type="number"
                                        placeholder="59"
                                        value={firstVisitCost}
                                        onChange={(e) => setFirstVisitCost(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Your Name (VA)</label>
                                    <input 
                                        type="text"
                                        placeholder="Optional"
                                        value={vaName}
                                        onChange={(e) => setVaName(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <h3 style={{marginBottom: '20px', marginTop: '30px'}}>Select Difficulty:</h3>
                            <div className="difficulty-grid">
                                <div className={`difficulty-btn ${difficulty === 'easy' ? 'selected' : ''}`} onClick={() => setDifficulty('easy')}>
                                    <div style={{fontSize: '24px'}}>ðŸ˜Š</div>
                                    <div><strong>Easy</strong></div>
                                    <div style={{fontSize: '12px'}}>Cooperative patient, no questions</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'challenging' ? 'selected' : ''}`} onClick={() => setDifficulty('challenging')}>
                                    <div style={{fontSize: '24px'}}>ðŸ¤”</div>
                                    <div><strong>Challenging</strong></div>
                                    <div style={{fontSize: '12px'}}>Asks 2-3 random questions, then books</div>
                                </div>
                            </div>
                            <button className="start-btn" onClick={startCall} disabled={!canStart}>
                                {canStart ? 'Start Call' : 'Fill in all fields'}
                            </button>
                        </div>
                    </div>
                );
            }

            // PLAYING SCREEN
            if (gameState === 'playing') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>ðŸ“ž Call In Progress</h1>
                            <p>{officeName} - {difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Mode</p>
                        </div>
                        <div className="content">
                            <div className={`status-box status-${currentStatus}`}>
                                {currentStatus === 'listening' && 'ðŸŽ¤ Listening to you...'}
                                {currentStatus === 'speaking' && 'ðŸ”Š Patient speaking...'}
                                {currentStatus === 'thinking' && 'ðŸ’­ Processing...'}
                                {currentStatus === 'idle' && 'â¸ï¸ Ready'}
                            </div>
                            
                            {interimText && (
                                <div style={{padding: '10px', background: '#f0f0f0', borderRadius: '8px', marginBottom: '15px', fontStyle: 'italic'}}>
                                    Hearing: "{interimText}"
                                </div>
                            )}
                            
                            <div className="chat-container">
                                {messages.map((msg, i) => (
                                    <div key={i} className={`message ${msg.type}`}>
                                        {msg.type === 'staff' && <strong>You: </strong>}
                                        {msg.type === 'patient' && <strong>Patient: </strong>}
                                        {msg.text}
                                    </div>
                                ))}
                            </div>
                            
                            <button className="end-call-btn" onClick={endCall}>
                                â¹ï¸ End Call & Get Score
                            </button>
                        </div>
                    </div>
                );
            }

            // SCORING SCREEN
            if (gameState === 'scoring') {
                const checkpointTotal = Object.values(scoreData.scores).reduce((sum, c) => sum + c.score, 0);
                const passed = scoreData.totalScore >= 70;

                return (
                    <div className="container">
                        <div className="header">
                            <h1>ðŸ“Š Your Score</h1>
                            <p>{passed ? 'âœ… PASSED' : 'âŒ NEEDS IMPROVEMENT'}</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                <div className="overall-score" style={{color: passed ? '#4caf50' : '#f44336'}}>
                                    {scoreData.totalScore}/100
                                </div>
                                
                                <div style={{textAlign: 'center', marginBottom: '20px', padding: '15px', background: scoreData.patientBooked ? '#e8f5e9' : '#ffebee', borderRadius: '10px'}}>
                                    <strong>{scoreData.patientBooked ? 'âœ… Patient Booked!' : 'âŒ Patient Did Not Book'}</strong>
                                </div>
                                
                                {scoreData.summary && (
                                    <div style={{marginBottom: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                        <strong>Summary:</strong> {scoreData.summary}
                                    </div>
                                )}
                                
                                <h3 style={{marginBottom: '15px'}}>7 Checkpoints ({checkpointTotal}/70):</h3>
                                
                                {Object.entries(scoreData.scores).map(([key, data]) => {
                                    const labels = {
                                        greeting: 'Greeting & Introduction',
                                        reason: 'Identified Reason for Call',
                                        scheduling: 'Scheduling & Time',
                                        patientInfo: 'Collected Patient Info',
                                        referral: 'Asked Referral Source',
                                        feeExplanation: 'Explained Fee & Inclusions',
                                        closing: 'Professional Closing'
                                    };
                                    
                                    return (
                                        <div key={key} className="score-item" style={{background: data.score >= 7 ? '#e8f5e9' : data.score >= 4 ? '#fff3e0' : '#ffebee'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <span>{data.score >= 7 ? 'âœ…' : data.score >= 4 ? 'âš ï¸' : 'âŒ'} {labels[key]}</span>
                                                <strong>{data.score}/10</strong>
                                            </div>
                                            {data.note && <p style={{fontSize: '13px', color: '#666', marginTop: '5px'}}>{data.note}</p>}
                                        </div>
                                    );
                                })}
                                
                                <div style={{marginTop: '15px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                    <strong>Bonus Points:</strong> {scoreData.bonus}/30
                                </div>
                                
                                {scoreData.positives?.filter(p => p).length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="positive">âœ… What You Did Well:</h4>
                                        <ul>{scoreData.positives.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                                
                                {scoreData.improvements?.filter(p => p).length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="negative">ðŸ“ˆ Areas to Improve:</h4>
                                        <ul>{scoreData.improvements.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                                
                                {scoreData.criticalMisses?.filter(p => p).length > 0 && (
                                    <div className="feedback-section" style={{background: '#ffebee'}}>
                                        <h4 className="critical">ðŸš¨ Critical Misses:</h4>
                                        <ul>{scoreData.criticalMisses.filter(p => p).map((item, i) => <li key={i}>{item}</li>)}</ul>
                                    </div>
                                )}
                            </div>
                            
                            <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Another Call</button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
