<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiro Voice Training 2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 40px; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .difficulty-btn {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .difficulty-btn:hover { border-color: #667eea; transform: translateY(-2px); }
        .difficulty-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .start-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-container {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.staff { background: #667eea; color: white; margin-left: auto; }
        .message.patient { background: white; border: 1px solid #ddd; }
        .message.system { background: #ffc107; text-align: center; max-width: 100%; }
        .end-call-btn {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .score-card { background: #f9f9f9; border-radius: 15px; padding: 25px; }
        .overall-score {
            font-size: 64px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .score-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status-listening { background: #e8f5e9; color: #2e7d32; }
        .status-speaking { background: #e3f2fd; color: #1565c0; }
        .status-thinking { background: #fff3e0; color: #ef6c00; }
        .status-waiting { background: #f3e5f5; color: #7b1fa2; }
        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        .feedback-section h4 {
            margin-bottom: 10px;
            color: #333;
        }
        .feedback-section ul {
            margin-left: 20px;
        }
        .feedback-section li {
            margin-bottom: 5px;
        }
        .positive { color: #2e7d32; }
        .negative { color: #c62828; }
        .critical { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const APP_PASSWORD = "ChiroTrain2025";
        const STORED_KEY = localStorage.getItem('openai_api_key');

        // Master Phone Script for evaluation reference
        const MASTER_PHONE_SCRIPT = `
MASTER PHONE SCRIPT FOR VA TRAINING:

STEP 1 - GREETING:
"Thank you for calling [Office Name], this is [VA Name], how may I help you?"

STEP 2 - IDENTIFY REASON:
Listen to patient's reason for calling. If booking appointment, proceed.

STEP 3 - SCHEDULING:
"Great! How soon would you like to come in?"
Offer available times based on patient preference.

STEP 4 - GET PATIENT INFO:
- "May I have your name?"
- "And a good phone number to reach you?"
- "Do you have an email address?"

STEP 5 - REFERRAL SOURCE:
"How did you hear about us?" (Google, friend, insurance, etc.)

STEP 6 - EXPLAIN FIRST VISIT:
"Your first visit will be [COST]. This includes a full consultation with [Doctor Name], examination, and any necessary X-rays."
"Please bring your ID and insurance card if you have one."

STEP 7 - CONFIRM & CLOSE:
"Great! You're all set for [DAY] at [TIME]. We look forward to seeing you!"
"Do you have any other questions?"
"Have a great day!"

CRITICAL REQUIREMENTS:
- MUST introduce with name AND office name
- MUST ask referral source
- MUST explain first visit cost
- MUST tell patient what to bring
- MUST confirm appointment details
- MUST close professionally
`;

        function ChiroVoiceTrainer() {
            const [isAuthenticated, setIsAuthenticated] = useState(sessionStorage.getItem('auth') === 'true');
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [apiKey, setApiKey] = useState(STORED_KEY || '');
            const [showApiPrompt, setShowApiPrompt] = useState(!STORED_KEY);
            const [gameState, setGameState] = useState('setup');
            
            // Form fields for clinic info
            const [officeName, setOfficeName] = useState('');
            const [doctorName, setDoctorName] = useState('');
            const [firstVisitCost, setFirstVisitCost] = useState('');
            const [vaName, setVaName] = useState('');
            
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [conversationHistory, setConversationHistory] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [scoreData, setScoreData] = useState(null);
            const [interimText, setInterimText] = useState('');
            const [isFirstMessage, setIsFirstMessage] = useState(true);

            const recognitionRef = useRef(null);
            const shouldListenRef = useRef(false);
            const isProcessingRef = useRef(false);
            const silenceTimerRef = useRef(null);
            const lastTranscriptRef = useRef('');
            const audioRef = useRef(null);

            const checkPassword = () => {
                if (passwordInput === APP_PASSWORD) {
                    sessionStorage.setItem('auth', 'true');
                    setIsAuthenticated(true);
                } else {
                    setPasswordError('Wrong password');
                    setPasswordInput('');
                }
            };

            const saveApiKey = () => {
                localStorage.setItem('openai_api_key', apiKey);
                setShowApiPrompt(false);
            };

            // Build the PATIENT_MODE system prompt
            const buildPatientModePrompt = () => {
                const clinicInfo = `
CLINIC_INFO:
- Office Name: ${officeName}
- Doctor Name: Dr. ${doctorName}
- First Visit Cost: $${firstVisitCost}
- Services: Chiropractic adjustments, decompression therapy, Class IV laser, shockwave therapy
`;

                return `You are an AI Patient Simulator for training human Virtual Assistants (VAs) in a chiropractic office.

MODE: PATIENT_MODE
DIFFICULTY: ${difficulty.toUpperCase()}

${clinicInfo}

MASTER_PHONE_SCRIPT (for reference - this is what the VA SHOULD do, NOT what you do):
${MASTER_PHONE_SCRIPT}

===========================
YOUR ROLE: PATIENT ONLY
===========================

You act ONLY as the PATIENT on a LIVE phone call.

CRITICAL RULES:

---------------------------------------
RULE 1: WAIT FOR VA TO SPEAK FIRST
---------------------------------------
If the conversation is empty or just started, DO NOT SAY ANYTHING yet.
You only speak AFTER the VA's first greeting.
If VA hasn't spoken, respond with: [WAITING FOR VA GREETING]

---------------------------------------
RULE 2: FIRST LINE = BOOKING INTENT
---------------------------------------
Your FIRST line as patient MUST express booking intent:
- "Hi, I'd like to schedule an appointment"
- "Hi, I want to book an appointment for my back pain"
- "Hello, I'm calling to make an appointment"

DO NOT ask questions before expressing booking intent.

---------------------------------------
RULE 3: YOU ARE THE PATIENT ONLY
---------------------------------------
You must NEVER:
- Act like the VA or clinic staff
- Say clinic greetings like "Thank you for calling..."
- Try to schedule someone else
- Redirect calls
- Ask "how can I help you"

You ONLY respond as a patient calling for help.

---------------------------------------
RULE 4: NO NUDGING (CRITICAL)
---------------------------------------
If the VA forgets to:
- Mention the first visit fee
- Explain what the fee covers
- Ask what to bring
- Ask how you heard about them
- Get your email/phone

You DO NOT remind them or ask leading questions.
You ONLY ask questions appropriate for your difficulty level.

---------------------------------------
RULE 5: APPOINTMENT LOGIC
---------------------------------------
Once VA confirms date/time:
- Acknowledge it
- Provide your details when asked
- DO NOT ask to book again
- DO NOT restart the flow

---------------------------------------
RULE 6: VA ENDS THE CALL
---------------------------------------
You NEVER end the call first.
You NEVER say goodbye first.
When VA closes, give a brief "Okay, thank you!" response.

---------------------------------------
DIFFICULTY: ${difficulty.toUpperCase()}
---------------------------------------
${getDifficultyBehavior(difficulty)}

---------------------------------------
YOUR PATIENT IDENTITY
---------------------------------------
${getPatientIdentity(difficulty)}

---------------------------------------
OUTPUT FORMAT
---------------------------------------
Respond with ONLY the patient's next spoken line.
No labels, no brackets, no explanations.
Keep responses to 1-2 sentences maximum.
`;
            };

            const getDifficultyBehavior = (diff) => {
                switch(diff) {
                    case 'easy':
                        return `EASY MODE BEHAVIOR:
- Fully cooperative
- Does NOT initiate questions unless VA asks first
- Only answers what VA asks
- Gives information promptly when requested
- Always books the appointment
- Short, friendly responses`;
                    
                    case 'challenging':
                        return `CHALLENGING MODE BEHAVIOR:
- Wants to book BUT has concerns
- May ask 1-3 realistic questions: insurance coverage, total cost, visit length
- Will book if VA handles questions well
- May hesitate or say "I need to think about it" if VA is unclear
- DO NOT nudge about missing script items`;
                    
                    case 'difficult':
                        return `SKEPTICAL MODE BEHAVIOR:
- Has been burned before, very cautious
- Asks tough questions: hidden fees, how many visits, why so expensive
- Pushes back on vague answers
- Booking is CONDITIONAL on VA performance
- If VA earns trust with clear answers: book
- If VA is evasive or unclear: politely decline
- DO NOT nudge about missing script items`;
                    
                    case 'creepy':
                        return `CREEPY MODE BEHAVIOR:
- First 1-2 messages: COMPLETELY NORMAL (like easy mode)
- After that: gradually become inappropriate
- Ask personal questions about the staff member
- Make mildly uncomfortable comments
- Be overly friendly in a weird way
- NEVER explicit, graphic, threatening, or abusive
- If VA sets boundaries, follow their lead
- Test if VA can professionally end the call`;
                    
                    default:
                        return '';
                }
            };

            const getPatientIdentity = (diff) => {
                switch(diff) {
                    case 'easy':
                        return `Name: Sarah Johnson
Phone: 555-867-5309
Email: sarah.johnson@email.com
Problem: Back pain for about 2 weeks
Availability: This week, mornings preferred
How you found them: A friend recommended
Personality: Friendly, cooperative, easy-going`;
                    
                    case 'challenging':
                        return `Name: Mike Davis
Phone: 555-234-5678
Email: mike.davis@email.com
Problem: Neck pain and stiffness
Insurance: Blue Cross Blue Shield
Availability: Flexible
How you found them: Google search
Personality: Price-conscious, wants value for money`;
                    
                    case 'difficult':
                        return `Name: Karen Miller
Phone: 555-345-6789
Email: karen.m@email.com
Problem: Lower back pain, chronic
Insurance: Aetna
Availability: Afternoons only
How you found them: Insurance website
Personality: Skeptical, been overcharged before, wants specifics`;
                    
                    case 'creepy':
                        return `Name: (gives name only if directly asked) - "Just call me... a friend"
Phone: (reluctant to give)
Problem: (vague) "Oh, I just have some... tension"
Personality: Starts normal, becomes increasingly inappropriate`;
                    
                    default:
                        return '';
                }
            };

            // Call OpenAI for patient response
            const callPatientMode = async (conversationSoFar) => {
                const systemPrompt = buildPatientModePrompt();
                
                // Build conversation context
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // Add conversation history with clear labels
                conversationSoFar.forEach(msg => {
                    if (msg.role === 'va') {
                        messages.push({ role: 'user', content: `VA: ${msg.content}` });
                    } else if (msg.role === 'patient') {
                        messages.push({ role: 'assistant', content: msg.content });
                    }
                });
                
                // If no VA message yet, tell AI to wait
                if (conversationSoFar.length === 0) {
                    messages.push({ role: 'user', content: '[Call just connected - VA has not spoken yet]' });
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: messages,
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                let reply = data.choices[0].message.content.trim();
                
                // If AI says it's waiting, return null
                if (reply.includes('[WAITING') || reply.toLowerCase().includes('waiting for va')) {
                    return null;
                }
                
                return reply;
            };

            // Call OpenAI for evaluation
            const callEvalMode = async (fullTranscript) => {
                const evalPrompt = `You are an AI Call Evaluator for training Virtual Assistants in a chiropractic office.

MODE: EVAL_MODE
DIFFICULTY: ${difficulty.toUpperCase()}

CLINIC_INFO:
- Office Name: ${officeName}
- Doctor Name: Dr. ${doctorName}
- First Visit Cost: $${firstVisitCost}

MASTER_PHONE_SCRIPT (what VA SHOULD have done):
${MASTER_PHONE_SCRIPT}

FULL_TRANSCRIPT:
${fullTranscript}

===========================
EVALUATION INSTRUCTIONS
===========================

Evaluate the VA's performance based ONLY on what they actually said.
Do NOT continue the call. Do NOT generate dialog.

Score each checkpoint from 0-10:

1. GREETING & IDENTITY - Did VA introduce themselves with name AND office name?
2. REASON FOR CALL - Did VA identify patient's main concern?
3. APPOINTMENT & TIME - Did VA offer and confirm a specific appointment time?
4. PATIENT INFO - Did VA collect name AND contact info (phone/email)?
5. INITIAL FEE & COVERAGE - Did VA explain the first visit cost AND what it includes?
6. EXPECTATIONS & WHAT TO BRING - Did VA explain what to bring (ID, insurance)?
7. PROFESSIONAL CLOSING - Did VA close professionally and confirm details?

Additional scoring (up to 30 points):
- Flow & naturalness
- Professionalism
- Confidence
- Handling the ${difficulty} difficulty appropriately

IMPORTANT: If patient refused to book (CHALLENGING or SKEPTICAL mode), explain WHY based on VA's performance.

Respond with ONLY valid JSON in this exact format:
{
    "totalScore": number,
    "checkpoints": {
        "greetingIdentity": { "score": number, "comment": "brief explanation" },
        "reasonForCall": { "score": number, "comment": "brief explanation" },
        "appointmentAndTime": { "score": number, "comment": "brief explanation" },
        "patientInfo": { "score": number, "comment": "brief explanation" },
        "initialFeeAndCoverage": { "score": number, "comment": "brief explanation" },
        "expectationsAndWhatToBring": { "score": number, "comment": "brief explanation" },
        "professionalClosing": { "score": number, "comment": "brief explanation" }
    },
    "bonusPoints": number,
    "positiveFeedback": ["string", "string"],
    "areasToImprove": ["string", "string"],
    "criticalMisses": ["string if any critical step was completely missed"],
    "patientBooked": boolean,
    "bookingNote": "why patient did or didn't book"
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: evalPrompt }],
                        max_tokens: 1000,
                        temperature: 0.3
                    })
                });
                
                const data = await response.json();
                let content = data.choices[0].message.content.trim();
                
                // Clean up JSON response
                content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                try {
                    return JSON.parse(content);
                } catch (e) {
                    console.error('Failed to parse eval response:', content);
                    return null;
                }
            };

            const playAudio = async (text) => {
                setCurrentStatus('speaking');
                shouldListenRef.current = false;
                
                try {
                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            input: text,
                            voice: 'nova'
                        })
                    });
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audioRef.current = audio;
                    
                    audio.onended = () => {
                        setCurrentStatus('listening');
                        shouldListenRef.current = true;
                        startListening();
                    };
                    
                    await audio.play();
                } catch (error) {
                    console.error('Audio error:', error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
            };

            const startListening = () => {
                if (recognitionRef.current && shouldListenRef.current) {
                    try {
                        recognitionRef.current.start();
                    } catch (e) {}
                }
            };

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }

                        if (interim) setInterimText(interim);
                        
                        if (final && shouldListenRef.current && !isProcessingRef.current) {
                            if (silenceTimerRef.current) clearTimeout(silenceTimerRef.current);
                            
                            lastTranscriptRef.current = (lastTranscriptRef.current + ' ' + final).trim();
                            setInterimText(lastTranscriptRef.current);
                            
                            silenceTimerRef.current = setTimeout(() => {
                                if (lastTranscriptRef.current && shouldListenRef.current) {
                                    handleStaffResponse(lastTranscriptRef.current);
                                    lastTranscriptRef.current = '';
                                    setInterimText('');
                                }
                            }, 1500);
                        }
                    };

                    recognitionRef.current.onend = () => {
                        if (shouldListenRef.current) {
                            try { recognitionRef.current.start(); } catch (e) {}
                        }
                    };
                }
            }, []);

            const startCall = async () => {
                if (!difficulty || !officeName || !doctorName || !firstVisitCost) return;
                
                setGameState('playing');
                setMessages([]);
                setConversationHistory([]);
                setIsFirstMessage(true);
                
                // VA speaks first - show waiting message
                setMessages([{ 
                    type: 'system', 
                    text: 'üìû Incoming call! Answer with your greeting...' 
                }]);
                
                // Start listening for VA's greeting
                setCurrentStatus('waiting');
                setTimeout(() => {
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }, 1000);
            };

            const handleStaffResponse = async (transcript) => {
                if (isProcessingRef.current) return;
                isProcessingRef.current = true;
                shouldListenRef.current = false;
                
                if (recognitionRef.current) {
                    try { recognitionRef.current.stop(); } catch (e) {}
                }
                
                setCurrentStatus('thinking');
                setMessages(prev => [...prev, { type: 'staff', text: transcript }]);
                
                // Add VA message to conversation history
                const newHistory = [...conversationHistory, { role: 'va', content: transcript }];
                setConversationHistory(newHistory);
                
                try {
                    // Get patient response
                    const response = await callPatientMode(newHistory);
                    
                    if (response) {
                        setMessages(prev => [...prev, { type: 'patient', text: response }]);
                        setConversationHistory(prev => [...prev, { role: 'patient', content: response }]);
                        setIsFirstMessage(false);
                        
                        // Play audio response
                        await playAudio(response);
                    } else {
                        // AI is waiting - shouldn't happen after VA speaks
                        setCurrentStatus('listening');
                        shouldListenRef.current = true;
                        startListening();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
                
                isProcessingRef.current = false;
            };

            const endCall = async () => {
                shouldListenRef.current = false;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                
                setCurrentStatus('thinking');
                setMessages(prev => [...prev, { type: 'system', text: 'üìä Evaluating your performance...' }]);
                
                // Build transcript
                const transcript = conversationHistory
                    .map(msg => `${msg.role === 'va' ? 'VA' : 'PATIENT'}: ${msg.content}`)
                    .join('\n');
                
                // Handle creepy mode differently
                if (difficulty === 'creepy') {
                    const handled = conversationHistory.some(msg => 
                        msg.role === 'va' && 
                        (msg.content.toLowerCase().includes('inappropriate') ||
                         msg.content.toLowerCase().includes('end this call') ||
                         msg.content.toLowerCase().includes('hang up') ||
                         msg.content.toLowerCase().includes('not appropriate') ||
                         msg.content.toLowerCase().includes('have a nice day'))
                    );
                    
                    setScoreData({
                        isCreepy: true,
                        passed: handled,
                        result: handled ? 'PASS ‚úÖ' : 'NEEDS WORK',
                        feedback: handled 
                            ? 'Good job! You recognized the inappropriate behavior and handled it professionally.'
                            : 'Remember to set boundaries and end calls professionally when callers become inappropriate.'
                    });
                    setGameState('scoring');
                    return;
                }
                
                // Get AI evaluation
                const evalResult = await callEvalMode(transcript);
                
                if (evalResult) {
                    setScoreData(evalResult);
                } else {
                    // Fallback if eval fails
                    setScoreData({
                        totalScore: 50,
                        checkpoints: {
                            greetingIdentity: { score: 5, comment: 'Could not evaluate' },
                            reasonForCall: { score: 5, comment: 'Could not evaluate' },
                            appointmentAndTime: { score: 5, comment: 'Could not evaluate' },
                            patientInfo: { score: 5, comment: 'Could not evaluate' },
                            initialFeeAndCoverage: { score: 5, comment: 'Could not evaluate' },
                            expectationsAndWhatToBring: { score: 5, comment: 'Could not evaluate' },
                            professionalClosing: { score: 5, comment: 'Could not evaluate' }
                        },
                        bonusPoints: 15,
                        positiveFeedback: ['Call completed'],
                        areasToImprove: ['Try again for detailed feedback'],
                        criticalMisses: [],
                        patientBooked: true,
                        bookingNote: 'Evaluation unavailable'
                    });
                }
                
                setGameState('scoring');
            };

            const resetGame = () => {
                shouldListenRef.current = false;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                setGameState('setup');
                setDifficulty('');
                setMessages([]);
                setConversationHistory([]);
                setScoreData(null);
                setCurrentStatus('idle');
                setIsFirstMessage(true);
            };

            // PASSWORD SCREEN
            if (!isAuthenticated) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîê Chiro Voice Training</h1>
                            <p>Enter password to access</p>
                        </div>
                        <div className="content" style={{textAlign: 'center'}}>
                            <input 
                                type="password"
                                placeholder="Password"
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && checkPassword()}
                                style={{padding: '15px', fontSize: '16px', width: '100%', maxWidth: '300px', marginBottom: '15px', borderRadius: '10px', border: '2px solid #667eea'}}
                            />
                            {passwordError && <p style={{color: 'red', marginBottom: '15px'}}>{passwordError}</p>}
                            <br/>
                            <button className="start-btn" style={{maxWidth: '300px'}} onClick={checkPassword}>Access</button>
                        </div>
                    </div>
                );
            }

            // API KEY SCREEN
            if (showApiPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîë API Key Required</h1>
                            <p>Enter your OpenAI API key</p>
                        </div>
                        <div className="content" style={{textAlign: 'center'}}>
                            <input 
                                type="password"
                                placeholder="sk-proj-..."
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                style={{padding: '15px', fontSize: '16px', width: '100%', marginBottom: '15px', borderRadius: '10px', border: '2px solid #667eea'}}
                            />
                            <button className="start-btn" onClick={saveApiKey} disabled={!apiKey}>Save & Continue</button>
                            <p style={{marginTop: '20px', color: '#666'}}>
                                Get key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                            </p>
                        </div>
                    </div>
                );
            }

            // SETUP SCREEN
            if (gameState === 'setup') {
                const canStart = difficulty && officeName && doctorName && firstVisitCost;
                
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training 2.0</h1>
                            <p>Practice handling patient calls</p>
                        </div>
                        <div className="content">
                            <h3 style={{marginBottom: '20px'}}>Clinic Information:</h3>
                            
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Office Name *</label>
                                    <input 
                                        type="text"
                                        placeholder="Brighton Spine & Wellness"
                                        value={officeName}
                                        onChange={(e) => setOfficeName(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Doctor Name *</label>
                                    <input 
                                        type="text"
                                        placeholder="Smith"
                                        value={doctorName}
                                        onChange={(e) => setDoctorName(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <div className="form-row">
                                <div className="form-group">
                                    <label>First Visit Cost ($) *</label>
                                    <input 
                                        type="number"
                                        placeholder="59"
                                        value={firstVisitCost}
                                        onChange={(e) => setFirstVisitCost(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Your Name (VA)</label>
                                    <input 
                                        type="text"
                                        placeholder="Optional"
                                        value={vaName}
                                        onChange={(e) => setVaName(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <h3 style={{marginBottom: '20px', marginTop: '30px'}}>Select Difficulty:</h3>
                            <div className="difficulty-grid">
                                <div className={`difficulty-btn ${difficulty === 'easy' ? 'selected' : ''}`} onClick={() => setDifficulty('easy')}>
                                    <div style={{fontSize: '24px'}}>üòä</div>
                                    <div><strong>Easy</strong></div>
                                    <div style={{fontSize: '12px'}}>Cooperative patient</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'challenging' ? 'selected' : ''}`} onClick={() => setDifficulty('challenging')}>
                                    <div style={{fontSize: '24px'}}>ü§î</div>
                                    <div><strong>Challenging</strong></div>
                                    <div style={{fontSize: '12px'}}>Price-conscious</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'difficult' ? 'selected' : ''}`} onClick={() => setDifficulty('difficult')}>
                                    <div style={{fontSize: '24px'}}>üò§</div>
                                    <div><strong>Skeptical</strong></div>
                                    <div style={{fontSize: '12px'}}>Needs convincing</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'creepy' ? 'selected' : ''}`} onClick={() => setDifficulty('creepy')}>
                                    <div style={{fontSize: '24px'}}>üòà</div>
                                    <div><strong>Creepy</strong></div>
                                    <div style={{fontSize: '12px'}}>Inappropriate caller</div>
                                </div>
                            </div>
                            <button className="start-btn" onClick={startCall} disabled={!canStart}>
                                {canStart ? 'Start Call' : 'Fill in all fields'}
                            </button>
                        </div>
                    </div>
                );
            }

            // PLAYING SCREEN
            if (gameState === 'playing') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Call In Progress</h1>
                            <p>{officeName} - {difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Mode</p>
                        </div>
                        <div className="content">
                            <div className={`status-box ${currentStatus === 'waiting' ? 'status-waiting' : `status-${currentStatus}`}`}>
                                {currentStatus === 'waiting' && 'üìû Answer the call with your greeting!'}
                                {currentStatus === 'listening' && 'üé§ Listening to you...'}
                                {currentStatus === 'speaking' && 'üîä Patient speaking...'}
                                {currentStatus === 'thinking' && 'üí≠ Processing...'}
                                {currentStatus === 'idle' && '‚è∏Ô∏è Ready'}
                            </div>
                            
                            {interimText && (
                                <div style={{padding: '10px', background: '#f0f0f0', borderRadius: '8px', marginBottom: '15px', fontStyle: 'italic'}}>
                                    Hearing: "{interimText}"
                                </div>
                            )}
                            
                            <div className="chat-container">
                                {messages.map((msg, i) => (
                                    <div key={i} className={`message ${msg.type}`}>
                                        {msg.type === 'staff' && <strong>You: </strong>}
                                        {msg.type === 'patient' && <strong>Patient: </strong>}
                                        {msg.text}
                                    </div>
                                ))}
                            </div>
                            
                            <button className="end-call-btn" onClick={endCall}>
                                ‚èπÔ∏è End Call & Get Score
                            </button>
                        </div>
                    </div>
                );
            }

            // SCORING SCREEN
            if (gameState === 'scoring') {
                // Creepy mode result
                if (scoreData.isCreepy) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>üö® Creepy Caller Result</h1>
                            </div>
                            <div className="content">
                                <div className="score-card">
                                    <div className="overall-score" style={{color: scoreData.passed ? '#4caf50' : '#ff9800'}}>
                                        {scoreData.result}
                                    </div>
                                    <p style={{textAlign: 'center', fontSize: '18px'}}>{scoreData.feedback}</p>
                                </div>
                                <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Again</button>
                            </div>
                        </div>
                    );
                }

                // Regular scoring
                const checkpointTotal = Object.values(scoreData.checkpoints).reduce((sum, c) => sum + c.score, 0);
                const passed = scoreData.totalScore >= 70;

                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìä Your Score</h1>
                            <p>{passed ? '‚úÖ PASSED' : '‚ùå NEEDS IMPROVEMENT'}</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                <div className="overall-score" style={{color: passed ? '#4caf50' : '#f44336'}}>
                                    {scoreData.totalScore}/100
                                </div>
                                
                                {/* Booking Status */}
                                <div style={{textAlign: 'center', marginBottom: '20px', padding: '15px', background: scoreData.patientBooked ? '#e8f5e9' : '#ffebee', borderRadius: '10px'}}>
                                    <strong>{scoreData.patientBooked ? '‚úÖ Patient Booked!' : '‚ùå Patient Did Not Book'}</strong>
                                    <p style={{marginTop: '5px', fontSize: '14px'}}>{scoreData.bookingNote}</p>
                                </div>
                                
                                <h3 style={{marginBottom: '15px'}}>7 Checkpoints ({checkpointTotal}/70):</h3>
                                
                                {Object.entries(scoreData.checkpoints).map(([key, data]) => {
                                    const labels = {
                                        greetingIdentity: 'Greeting & Identity',
                                        reasonForCall: 'Reason for Call',
                                        appointmentAndTime: 'Appointment & Time',
                                        patientInfo: 'Patient Info',
                                        initialFeeAndCoverage: 'Fee & What It Covers',
                                        expectationsAndWhatToBring: 'What to Bring',
                                        professionalClosing: 'Professional Closing'
                                    };
                                    
                                    return (
                                        <div key={key} className="score-item" style={{background: data.score >= 7 ? '#e8f5e9' : data.score >= 4 ? '#fff3e0' : '#ffebee'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                <span>
                                                    {data.score >= 7 ? '‚úÖ' : data.score >= 4 ? '‚ö†Ô∏è' : '‚ùå'} {labels[key]}
                                                </span>
                                                <strong>{data.score}/10</strong>
                                            </div>
                                            <p style={{fontSize: '13px', color: '#666', marginTop: '5px'}}>{data.comment}</p>
                                        </div>
                                    );
                                })}
                                
                                <div style={{marginTop: '15px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                    <strong>Bonus Points:</strong> {scoreData.bonusPoints}/30
                                </div>
                                
                                {/* Feedback sections */}
                                {scoreData.positiveFeedback && scoreData.positiveFeedback.length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="positive">‚úÖ What You Did Well:</h4>
                                        <ul>
                                            {scoreData.positiveFeedback.map((item, i) => (
                                                <li key={i}>{item}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                
                                {scoreData.areasToImprove && scoreData.areasToImprove.length > 0 && (
                                    <div className="feedback-section">
                                        <h4 className="negative">üìà Areas to Improve:</h4>
                                        <ul>
                                            {scoreData.areasToImprove.map((item, i) => (
                                                <li key={i}>{item}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                
                                {scoreData.criticalMisses && scoreData.criticalMisses.length > 0 && (
                                    <div className="feedback-section" style={{background: '#ffebee'}}>
                                        <h4 className="critical">üö® Critical Misses:</h4>
                                        <ul>
                                            {scoreData.criticalMisses.map((item, i) => (
                                                <li key={i}>{item}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                            
                            <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Another Call</button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
