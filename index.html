<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiro Voice Training 2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 40px; }
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .difficulty-btn {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .difficulty-btn:hover { border-color: #667eea; transform: translateY(-2px); }
        .difficulty-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .start-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-container {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.patient { background: #667eea; color: white; margin-left: auto; }
        .message.staff { background: white; border: 1px solid #ddd; }
        .message.system { background: #ffc107; text-align: center; max-width: 100%; }
        .end-call-btn {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .score-card { background: #f9f9f9; border-radius: 15px; padding: 25px; }
        .overall-score {
            font-size: 64px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .score-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status-listening { background: #e8f5e9; color: #2e7d32; }
        .status-speaking { background: #e3f2fd; color: #1565c0; }
        .status-thinking { background: #fff3e0; color: #ef6c00; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const APP_PASSWORD = "ChiroTrain2025";
        const STORED_KEY = localStorage.getItem('openai_api_key');

        function ChiroVoiceTrainer() {
            const [isAuthenticated, setIsAuthenticated] = useState(sessionStorage.getItem('auth') === 'true');
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [apiKey, setApiKey] = useState(STORED_KEY || '');
            const [showApiPrompt, setShowApiPrompt] = useState(!STORED_KEY);
            const [gameState, setGameState] = useState('setup');
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [conversationHistory, setConversationHistory] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [scoreData, setScoreData] = useState(null);
            const [interimText, setInterimText] = useState('');

            const recognitionRef = useRef(null);
            const shouldListenRef = useRef(false);
            const isProcessingRef = useRef(false);
            const silenceTimerRef = useRef(null);
            const lastTranscriptRef = useRef('');
            const audioRef = useRef(null);

            const checkPassword = () => {
                if (passwordInput === APP_PASSWORD) {
                    sessionStorage.setItem('auth', 'true');
                    setIsAuthenticated(true);
                } else {
                    setPasswordError('Wrong password');
                    setPasswordInput('');
                }
            };

            const saveApiKey = () => {
                localStorage.setItem('openai_api_key', apiKey);
                setShowApiPrompt(false);
            };

            const callOpenAI = async (messages) => {
                // Add reinforcement to stay in patient role
                const reinforcedMessages = [
                    ...messages,
                    { role: 'system', content: 'Remember: You are the PATIENT calling in. Give a brief response as the patient would. Never act like staff.' }
                ];
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: reinforcedMessages,
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            };

            const playAudio = async (text) => {
                setCurrentStatus('speaking');
                shouldListenRef.current = false;
                
                try {
                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            input: text,
                            voice: 'nova'
                        })
                    });
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audioRef.current = audio;
                    
                    audio.onended = () => {
                        setCurrentStatus('listening');
                        shouldListenRef.current = true;
                        startListening();
                    };
                    
                    await audio.play();
                } catch (error) {
                    console.error('Audio error:', error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
            };

            const startListening = () => {
                if (recognitionRef.current && shouldListenRef.current) {
                    try {
                        recognitionRef.current.start();
                    } catch (e) {}
                }
            };

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }

                        if (interim) setInterimText(interim);
                        
                        if (final && shouldListenRef.current && !isProcessingRef.current) {
                            if (silenceTimerRef.current) clearTimeout(silenceTimerRef.current);
                            
                            lastTranscriptRef.current = (lastTranscriptRef.current + ' ' + final).trim();
                            setInterimText(lastTranscriptRef.current);
                            
                            silenceTimerRef.current = setTimeout(() => {
                                if (lastTranscriptRef.current && shouldListenRef.current) {
                                    handleStaffResponse(lastTranscriptRef.current);
                                    lastTranscriptRef.current = '';
                                    setInterimText('');
                                }
                            }, 1500);
                        }
                    };

                    recognitionRef.current.onend = () => {
                        if (shouldListenRef.current) {
                            try { recognitionRef.current.start(); } catch (e) {}
                        }
                    };
                }
            }, []);

            const difficultyPrompts = {
                easy: `CRITICAL INSTRUCTION: You are role-playing as a PATIENT who is CALLING a doctor's office. 

NEVER act like staff. NEVER offer to help. NEVER ask "how can I assist you". You are the one CALLING IN for help.

You have back pain and want to book an appointment. The human talking to you is the receptionist/staff who will help YOU.

When they ask questions, give SHORT answers:
- "When can you come in?" ‚Üí "This week, mornings are better"
- "What's your name?" ‚Üí "John Smith"
- "Phone number?" ‚Üí "555-123-4567"
- "Email?" ‚Üí "john@email.com"  
- "How did you hear about us?" ‚Üí "A friend referred me"
- "What's your concern?" ‚Üí "I have back pain"

When they tell you the cost and confirm your appointment, say "Great, thank you!" and nothing more.

STAY IN CHARACTER AS THE PATIENT. Never switch to being helpful staff.`,

                challenging: `CRITICAL INSTRUCTION: You are role-playing as a PATIENT who is CALLING a doctor's office.

NEVER act like staff. NEVER offer to help. You are the one CALLING IN.

You want to book but you're worried about cost. The human is the receptionist helping YOU.

Ask about the cost. Ask if they take insurance. If they answer well, agree to book and answer their questions.

STAY IN CHARACTER AS THE PATIENT.`,

                difficult: `CRITICAL INSTRUCTION: You are role-playing as a PATIENT who is CALLING a doctor's office.

NEVER act like staff. NEVER offer to help. You are the one CALLING IN.

You're skeptical. You've been burned before. Ask tough questions about cost, hidden fees, treatment plans.

The human is the receptionist. If they give good answers, you might book.

STAY IN CHARACTER AS THE PATIENT.`,

                creepy: `CRITICAL INSTRUCTION: You are role-playing as a CALLER to a doctor's office.

NEVER act like staff. You are CALLING IN.

Start normal wanting to book. After 2 exchanges, start being inappropriate - ask personal questions about the staff member, make uncomfortable comments.

STAY IN CHARACTER AS THE CALLER.`
            };

            const startCall = async () => {
                if (!difficulty) return;
                
                setGameState('playing');
                setMessages([]);
                setConversationHistory([]);
                
                const systemPrompt = { role: 'system', content: difficultyPrompts[difficulty] };
                const history = [systemPrompt];
                
                setCurrentStatus('thinking');
                const firstMessage = await callOpenAI(history);
                
                setMessages([{ type: 'patient', text: firstMessage }]);
                setConversationHistory([...history, { role: 'assistant', content: firstMessage }]);
                
                await playAudio(firstMessage);
            };

            const handleStaffResponse = async (transcript) => {
                if (isProcessingRef.current) return;
                isProcessingRef.current = true;
                shouldListenRef.current = false;
                
                if (recognitionRef.current) {
                    try { recognitionRef.current.stop(); } catch (e) {}
                }
                
                setCurrentStatus('thinking');
                setMessages(prev => [...prev, { type: 'staff', text: transcript }]);
                
                const newHistory = [...conversationHistory, { role: 'user', content: transcript }];
                
                try {
                    const response = await callOpenAI(newHistory);
                    setMessages(prev => [...prev, { type: 'patient', text: response }]);
                    setConversationHistory([...newHistory, { role: 'assistant', content: response }]);
                    
                    const lower = response.toLowerCase();
                    if ((lower.includes('thank') || lower.includes('see you')) && response.split(' ').length < 10) {
                        setMessages(prev => [...prev, { type: 'system', text: '‚úÖ Call completed! Click End Call to see score.' }]);
                        setCurrentStatus('idle');
                        isProcessingRef.current = false;
                        return;
                    }
                    
                    await playAudio(response);
                } catch (error) {
                    console.error(error);
                    setCurrentStatus('listening');
                    shouldListenRef.current = true;
                    startListening();
                }
                
                isProcessingRef.current = false;
            };

            const endCall = async () => {
                shouldListenRef.current = false;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                
                setCurrentStatus('thinking');
                
                const convoText = messages
                    .filter(m => m.type !== 'system')
                    .map(m => `${m.type === 'patient' ? 'PATIENT' : 'STAFF'}: ${m.text}`)
                    .join('\n');

                if (difficulty === 'creepy') {
                    setScoreData({
                        isCreepy: true,
                        result: 'PASS',
                        feedback: 'Handled the call appropriately.'
                    });
                    setGameState('scoring');
                    return;
                }

                const steps = [
                    { name: 'greeting', q: 'Did STAFF introduce themselves with name AND office name?', max: 10 },
                    { name: 'scheduling', q: 'Did STAFF ask WHEN patient wants to come in?', max: 15 },
                    { name: 'name', q: 'Did STAFF ask for patient name?', max: 10 },
                    { name: 'referral', q: 'Did STAFF ask how patient heard about them? If patient mentioned "friend" or "google", that means staff asked.', max: 5 },
                    { name: 'phone', q: 'Did STAFF ask for phone number?', max: 5 },
                    { name: 'fee', q: 'Did STAFF mention cost/fee AND what to bring (ID/insurance)?', max: 20 },
                    { name: 'email', q: 'Did STAFF ask for email?', max: 5 }
                ];

                const results = {};
                let criticalTotal = 0;

                for (const step of steps) {
                    try {
                        const checkResponse = await callOpenAI([{
                            role: 'user',
                            content: `Conversation:\n${convoText}\n\nQuestion: ${step.q}\nAnswer YES or NO only.`
                        }]);
                        
                        const isYes = checkResponse.toUpperCase().includes('YES');
                        const score = isYes ? step.max : 0;
                        criticalTotal += score;
                        results[step.name] = { score, completed: isYes };
                    } catch (e) {
                        results[step.name] = { score: 0, completed: false };
                    }
                }

                const bonusTotal = 15;
                
                setScoreData({
                    critical_steps: {
                        greeting: results.greeting || { score: 0, completed: false },
                        scheduling: results.scheduling || { score: 0, completed: false },
                        name: results.name || { score: 0, completed: false },
                        referral: results.referral || { score: 0, completed: false },
                        phone: results.phone || { score: 0, completed: false },
                        fee_explanation: results.fee || { score: 0, completed: false },
                        email: results.email || { score: 0, completed: false }
                    },
                    critical_total: criticalTotal,
                    bonus_total: bonusTotal,
                    total_score: criticalTotal + bonusTotal,
                    passed: criticalTotal >= 56
                });
                
                setGameState('scoring');
            };

            const resetGame = () => {
                shouldListenRef.current = false;
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch (e) {}
                if (audioRef.current) audioRef.current.pause();
                setGameState('setup');
                setDifficulty('');
                setMessages([]);
                setConversationHistory([]);
                setScoreData(null);
                setCurrentStatus('idle');
            };

            // PASSWORD SCREEN
            if (!isAuthenticated) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîê Chiro Voice Training</h1>
                            <p>Enter password to access</p>
                        </div>
                        <div className="content" style={{textAlign: 'center'}}>
                            <input 
                                type="password"
                                placeholder="Password"
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && checkPassword()}
                                style={{padding: '15px', fontSize: '16px', width: '100%', maxWidth: '300px', marginBottom: '15px', borderRadius: '10px', border: '2px solid #667eea'}}
                            />
                            {passwordError && <p style={{color: 'red', marginBottom: '15px'}}>{passwordError}</p>}
                            <br/>
                            <button className="start-btn" style={{maxWidth: '300px'}} onClick={checkPassword}>Access</button>
                        </div>
                    </div>
                );
            }

            // API KEY SCREEN
            if (showApiPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîë API Key Required</h1>
                            <p>Enter your OpenAI API key</p>
                        </div>
                        <div className="content" style={{textAlign: 'center'}}>
                            <input 
                                type="password"
                                placeholder="sk-proj-..."
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                style={{padding: '15px', fontSize: '16px', width: '100%', marginBottom: '15px', borderRadius: '10px', border: '2px solid #667eea'}}
                            />
                            <button className="start-btn" onClick={saveApiKey} disabled={!apiKey}>Save & Continue</button>
                            <p style={{marginTop: '20px', color: '#666'}}>
                                Get key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                            </p>
                        </div>
                    </div>
                );
            }

            // SETUP SCREEN
            if (gameState === 'setup') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training 2.0</h1>
                            <p>Practice handling patient calls</p>
                        </div>
                        <div className="content">
                            <h2 style={{marginBottom: '20px'}}>Select Difficulty:</h2>
                            <div className="difficulty-grid">
                                <div className={`difficulty-btn ${difficulty === 'easy' ? 'selected' : ''}`} onClick={() => setDifficulty('easy')}>
                                    <div style={{fontSize: '24px'}}>üòä</div>
                                    <div><strong>Easy</strong></div>
                                    <div style={{fontSize: '12px'}}>Cooperative patient</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'challenging' ? 'selected' : ''}`} onClick={() => setDifficulty('challenging')}>
                                    <div style={{fontSize: '24px'}}>ü§î</div>
                                    <div><strong>Challenging</strong></div>
                                    <div style={{fontSize: '12px'}}>Price-conscious</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'difficult' ? 'selected' : ''}`} onClick={() => setDifficulty('difficult')}>
                                    <div style={{fontSize: '24px'}}>üò§</div>
                                    <div><strong>Difficult</strong></div>
                                    <div style={{fontSize: '12px'}}>Skeptical patient</div>
                                </div>
                                <div className={`difficulty-btn ${difficulty === 'creepy' ? 'selected' : ''}`} onClick={() => setDifficulty('creepy')}>
                                    <div style={{fontSize: '24px'}}>üòà</div>
                                    <div><strong>Creepy</strong></div>
                                    <div style={{fontSize: '12px'}}>Inappropriate caller</div>
                                </div>
                            </div>
                            <button className="start-btn" onClick={startCall} disabled={!difficulty}>
                                Start Call
                            </button>
                        </div>
                    </div>
                );
            }

            // PLAYING SCREEN
            if (gameState === 'playing') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Call In Progress</h1>
                            <p>Speak naturally - pause when done</p>
                        </div>
                        <div className="content">
                            <div className={`status-box status-${currentStatus}`}>
                                {currentStatus === 'listening' && 'üé§ Listening...'}
                                {currentStatus === 'speaking' && 'üîä Patient speaking...'}
                                {currentStatus === 'thinking' && 'üí≠ Processing...'}
                                {currentStatus === 'idle' && '‚è∏Ô∏è Ready'}
                            </div>
                            
                            {interimText && (
                                <div style={{padding: '10px', background: '#f0f0f0', borderRadius: '8px', marginBottom: '15px', fontStyle: 'italic'}}>
                                    Hearing: "{interimText}"
                                </div>
                            )}
                            
                            <div className="chat-container">
                                {messages.map((msg, i) => (
                                    <div key={i} className={`message ${msg.type}`}>{msg.text}</div>
                                ))}
                            </div>
                            
                            <button className="end-call-btn" onClick={endCall}>
                                ‚èπÔ∏è End Call & Get Score
                            </button>
                        </div>
                    </div>
                );
            }

            // SCORING SCREEN
            if (gameState === 'scoring') {
                if (scoreData.isCreepy) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>üö® Creepy Caller Result</h1>
                            </div>
                            <div className="content">
                                <div className="score-card">
                                    <div className="overall-score" style={{color: '#4caf50'}}>{scoreData.result}</div>
                                    <p>{scoreData.feedback}</p>
                                </div>
                                <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Again</button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìä Your Score</h1>
                            <p>{scoreData.passed ? '‚úÖ PASSED' : '‚ùå NEEDS IMPROVEMENT'}</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                <div className="overall-score" style={{color: scoreData.passed ? '#4caf50' : '#f44336'}}>
                                    {scoreData.total_score}/100
                                </div>
                                
                                <h3>Critical Steps ({scoreData.critical_total}/70):</h3>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.greeting.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.greeting.completed ? '‚úÖ' : '‚ùå'} Greeting with name & office: {scoreData.critical_steps.greeting.score}/10
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.scheduling.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.scheduling.completed ? '‚úÖ' : '‚ùå'} Asked when to come in: {scoreData.critical_steps.scheduling.score}/15
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.name.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.name.completed ? '‚úÖ' : '‚ùå'} Got patient name: {scoreData.critical_steps.name.score}/10
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.referral.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.referral.completed ? '‚úÖ' : '‚ùå'} Asked referral source: {scoreData.critical_steps.referral.score}/5
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.phone.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.phone.completed ? '‚úÖ' : '‚ùå'} Got phone number: {scoreData.critical_steps.phone.score}/5
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.fee_explanation.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.fee_explanation.completed ? '‚úÖ' : '‚ùå'} Explained fee & what to bring: {scoreData.critical_steps.fee_explanation.score}/20
                                </div>
                                
                                <div className="score-item" style={{background: scoreData.critical_steps.email.completed ? '#e8f5e9' : '#ffebee'}}>
                                    {scoreData.critical_steps.email.completed ? '‚úÖ' : '‚ùå'} Got email: {scoreData.critical_steps.email.score}/5
                                </div>
                                
                                <div style={{marginTop: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '10px'}}>
                                    <strong>Bonus Points:</strong> {scoreData.bonus_total}/30
                                </div>
                                
                                {!scoreData.passed && (
                                    <div style={{marginTop: '20px', padding: '15px', background: '#fff3cd', borderRadius: '10px'}}>
                                        <strong>üí° Tips:</strong> Make sure to complete all 7 critical steps to pass!
                                    </div>
                                )}
                            </div>
                            
                            <button className="start-btn" onClick={resetGame} style={{marginTop: '20px'}}>Try Another Call</button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
